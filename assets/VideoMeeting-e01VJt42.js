import{c as p,u as be,C as Ne,q as Se,a as Ce,r as n,j as t,h as u}from"./index-DW35rIVo.js";import{w as l,C as Me}from"./webrtc-DMq8_CN2.js";import{A as Re}from"./arrow-left-DY4_iDT3.js";import{C as Te}from"./check-DCSHekAZ.js";import{U as _e}from"./users-BN-OU-3M.js";import{U as Ee}from"./user-CleuBYpp.js";import{V as Ve}from"./video-D47MdYhU.js";import{M as $e,C as Ae}from"./monitor-eChx64j5.js";const Le=[["path",{d:"M8 3H5a2 2 0 0 0-2 2v3",key:"1dcmit"}],["path",{d:"M21 8V5a2 2 0 0 0-2-2h-3",key:"1e4gt3"}],["path",{d:"M3 16v3a2 2 0 0 0 2 2h3",key:"wsl5sc"}],["path",{d:"M16 21h3a2 2 0 0 0 2-2v-3",key:"18trek"}]],Oe=p("maximize",Le);const ze=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M16.95 16.95A7 7 0 0 1 5 12v-2",key:"cqa7eg"}],["path",{d:"M18.89 13.23A7 7 0 0 0 19 12v-2",key:"16hl24"}],["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}]],te=p("mic-off",ze);const De=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],Ie=p("mic",De);const Pe=[["path",{d:"M8 3v3a2 2 0 0 1-2 2H3",key:"hohbtr"}],["path",{d:"M21 8h-3a2 2 0 0 1-2-2V3",key:"5jw1f3"}],["path",{d:"M3 16h3a2 2 0 0 1 2 2v3",key:"198tvr"}],["path",{d:"M16 21v-3a2 2 0 0 1 2-2h3",key:"ph8mxp"}]],Ue=p("minimize",Pe);const Fe=[["path",{d:"M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272",key:"1wngk7"}],["path",{d:"M22 2 2 22",key:"y4kqgn"}],["path",{d:"M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473",key:"10hv5p"}]],qe=p("phone-off",Fe);const He=[["path",{d:"M10.66 6H14a2 2 0 0 1 2 2v2.5l5.248-3.062A.5.5 0 0 1 22 7.87v8.196",key:"w8jjjt"}],["path",{d:"M16 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2",key:"1xawa7"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],se=p("video-off",He);function et(){const L=be(),[x]=Ne(),{roomId:ae}=Se(),{accessToken:C,user:re}=Ce(),f=ae||x.get("room")||"",M=x.get("pwd")||"",R=x.get("name")||re?.nickname||"ËÆøÂÆ¢",O=x.get("token")||"",ne=x.get("creator")==="true",[z,D]=n.useState(!1),[ce,g]=n.useState(!0),[I,w]=n.useState(null),[v,T]=n.useState(!1),[j,_]=n.useState(!0),[P,U]=n.useState(!1),[F,q]=n.useState(!1),[H,J]=n.useState(!0),[B,G]=n.useState(!1),[K,E]=n.useState([]),[oe,Q]=n.useState([]),[ie,le]=n.useState(0),k=n.useRef(null),c=n.useRef(null),m=n.useRef(null),i=n.useRef(null),d=n.useRef({}),h=n.useRef([]),V=n.useRef(""),y=n.useRef(null);n.useEffect(()=>{if(!f){w("ÊàøÈó¥Âè∑‰∏çËÉΩ‰∏∫Á©∫"),g(!1);return}return de(),()=>{A()}},[f]),n.useEffect(()=>{const e=()=>{J(!0),y.current&&clearTimeout(y.current),y.current=setTimeout(()=>J(!1),3e3)};return window.addEventListener("mousemove",e),e(),()=>{window.removeEventListener("mousemove",e),y.current&&clearTimeout(y.current)}},[]),n.useEffect(()=>{if(!z)return;const e=setInterval(()=>{le(s=>s+1)},1e3);return()=>clearInterval(e)},[z]);const de=async()=>{try{g(!0),w(null),await ue();let e;if(O)if(e=O,ne&&C){const s=await l.getIceServers();h.current=s}else try{const s=await l.joinRoom(f,{password:M,display_name:R});h.current=s.ice_servers,e=s.ws_token}catch{h.current=[{urls:["stun:stun.l.google.com:19302"]}]}else if(C){e=C;const s=await l.getIceServers();h.current=s}else{const s=await l.joinRoom(f,{password:M,display_name:R});e=s.ws_token,h.current=s.ice_servers}fe(e)}catch(e){console.error("ÂàùÂßãÂåñ‰ºöËÆÆÂ§±Ë¥•:",e),w(e instanceof Error?e.message:"ÂàùÂßãÂåñ‰ºöËÆÆÂ§±Ë¥•"),g(!1)}},ue=async()=>{try{const e=await navigator.mediaDevices.enumerateDevices(),s=e.some(o=>o.kind==="videoinput"),a=e.some(o=>o.kind==="audioinput"),r={};if(s&&(r.video=!0),a&&(r.audio=!0),s||a){const o=await navigator.mediaDevices.getUserMedia(r);c.current=o,k.current&&(k.current.srcObject=o),_(s),T(!a)}}catch(e){console.warn("Ëé∑ÂèñÂ™í‰ΩìÊµÅÂ§±Ë¥•, ËøõÂÖ•ËßÇÁúãÊ®°Âºè:",e),_(!1),T(!0)}},fe=e=>{const s=l.createSignalingConnection(f,e);i.current=s,s.onopen=()=>{console.log("‚úÖ ‰ø°‰ª§ËøûÊé•Â∑≤Âª∫Á´ã"),D(!0),g(!1)},s.onmessage=a=>{const r=JSON.parse(a.data);me(r)},s.onclose=()=>{D(!1),console.log("üîå ‰ø°‰ª§ËøûÊé•Â∑≤Êñ≠ÂºÄ")},s.onerror=()=>{w("‰ø°‰ª§ËøûÊé•Â§±Ë¥•"),g(!1)}},me=async e=>{switch(e.type){case"joined":V.current=e.participant_id,E(e.participants);for(const s of e.participants)W(V.current,s.id)&&await Y(s.id);break;case"peer_joined":E(s=>[...s,e.participant]),W(V.current,e.participant.id)&&await Y(e.participant.id);break;case"peer_left":E(s=>s.filter(a=>a.id!==e.participant_id)),$(e.participant_id);break;case"offer":await he(e.from,e.sdp);break;case"answer":await pe(e.from,e.sdp);break;case"candidate":await xe(e.from,e.candidate);break;case"room_closed":w(`ÊàøÈó¥Â∑≤ÂÖ≥Èó≠: ${e.reason}`),A();break;case"error":console.error("ÊúçÂä°Âô®ÈîôËØØ:",e.code,e.message);break}},W=(e,s)=>e<s,X=e=>{const s={iceServers:h.current.map(r=>({urls:r.urls,username:r.username,credential:r.credential}))},a=new RTCPeerConnection(s);return c.current&&c.current.getTracks().forEach(r=>{a.addTrack(r,c.current)}),a.onicecandidate=r=>{r.candidate&&i.current&&l.sendCandidate(i.current,e,r.candidate.toJSON())},a.ontrack=r=>{console.log("Êî∂Âà∞ËøúÁ®ãÊµÅ:",e);const o=K.find(b=>b.id===e);o&&r.streams[0]&&Q(b=>b.find(N=>N.peerId===e)?b.map(N=>N.peerId===e?{...N,stream:r.streams[0]}:N):[...b,{peerId:e,stream:r.streams[0],participant:o}])},a.onconnectionstatechange=()=>{console.log(`PeerConnection ${e} Áä∂ÊÄÅ:`,a.connectionState),(a.connectionState==="failed"||a.connectionState==="disconnected")&&$(e)},d.current[e]=a,a},Y=async e=>{const s=X(e),a=await s.createOffer();await s.setLocalDescription(a),i.current&&a.sdp&&l.sendOffer(i.current,e,a.sdp)},he=async(e,s)=>{const a=X(e);await a.setRemoteDescription({type:"offer",sdp:s});const r=await a.createAnswer();await a.setLocalDescription(r),i.current&&r.sdp&&l.sendAnswer(i.current,e,r.sdp)},pe=async(e,s)=>{const a=d.current[e];a&&await a.setRemoteDescription({type:"answer",sdp:s})},xe=async(e,s)=>{const a=d.current[e];a&&await a.addIceCandidate(new RTCIceCandidate(s))},$=e=>{const s=d.current[e];s&&(s.close(),delete d.current[e]),Q(a=>a.filter(r=>r.peerId!==e))},A=()=>{Object.keys(d.current).forEach(e=>{$(e)}),i.current&&(l.leaveRoom(i.current),i.current.close(),i.current=null),c.current&&(c.current.getTracks().forEach(e=>e.stop()),c.current=null),m.current&&(m.current.getTracks().forEach(e=>e.stop()),m.current=null)},ge=()=>{c.current&&c.current.getAudioTracks().forEach(e=>{e.enabled=v}),T(!v)},we=()=>{c.current&&c.current.getVideoTracks().forEach(e=>{e.enabled=!j}),_(!j)},Z=async()=>{if(P){if(m.current&&(m.current.getTracks().forEach(e=>e.stop()),m.current=null),c.current){const e=c.current.getVideoTracks()[0];e&&Object.values(d.current).forEach(s=>{const a=s.getSenders().find(r=>r.track?.kind==="video");a&&a.replaceTrack(e)})}U(!1)}else try{const e=await navigator.mediaDevices.getDisplayMedia({video:{cursor:"always"},audio:!0});m.current=e;const s=e.getVideoTracks()[0];Object.values(d.current).forEach(a=>{const r=a.getSenders().find(o=>o.track?.kind==="video");r&&r.replaceTrack(s)}),k.current&&(k.current.srcObject=e),s.onended=()=>{Z()},U(!0)}catch(e){console.error("Â±èÂπïÂÖ±‰∫´Â§±Ë¥•:",e)}},ve=n.useCallback(()=>{document.fullscreenElement?(document.exitFullscreen(),q(!1)):(document.documentElement.requestFullscreen(),q(!0))},[]),ee=()=>{A(),L("/chat")},je=()=>{const e=`${window.location.origin}/video?room=${f}&pwd=${M}`;navigator.clipboard.writeText(e),G(!0),setTimeout(()=>G(!1),2e3)},ke=e=>{const s=Math.floor(e/3600),a=Math.floor(e%3600/60),r=e%60;return`${s.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`},ye=e=>{const s=["bg-red-500","bg-blue-500","bg-green-500","bg-purple-500","bg-pink-500","bg-orange-500"],a=e.split("").reduce((r,o)=>r+o.charCodeAt(0),0)%s.length;return s[a]},S=[{id:"local",isLocal:!0,stream:c.current,name:R},...oe.map(e=>({id:e.peerId,isLocal:!1,stream:e.stream,name:e.participant.name}))];return I?t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-900",children:t.jsxs("div",{className:"text-center text-white",children:[t.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Âá∫Èîô‰∫Ü"}),t.jsx("p",{className:"text-gray-400 mb-6",children:I}),t.jsx(u,{onClick:()=>L("/chat"),children:"ËøîÂõû"})]})}):ce?t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-900",children:t.jsxs("div",{className:"text-center text-white",children:[t.jsx("div",{className:"animate-spin w-16 h-16 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{children:"Ê≠£Âú®Âä†ÂÖ•‰ºöËÆÆ..."})]})}):t.jsxs("div",{className:`${F?"fixed inset-0":"min-h-screen"} bg-gray-900 flex flex-col`,children:[t.jsxs("header",{className:`h-14 bg-black/50 backdrop-blur-xl flex items-center justify-between px-4 transition-all ${H?"translate-y-0":"-translate-y-full"}`,children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs(u,{variant:"ghost",size:"sm",onClick:ee,className:"text-white",children:[t.jsx(Re,{className:"h-4 w-4 mr-2"}),"Á¶ªÂºÄ"]}),t.jsxs("div",{className:"flex items-center gap-2 text-white",children:[t.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),t.jsxs("span",{className:"text-sm",children:["ÊàøÈó¥: ",f]})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs(u,{variant:"ghost",size:"sm",onClick:je,className:"text-white",children:[B?t.jsx(Te,{className:"h-4 w-4"}):t.jsx(Me,{className:"h-4 w-4"}),t.jsx("span",{className:"ml-2",children:B?"Â∑≤Â§çÂà∂":"Â§çÂà∂ÈìæÊé•"})]}),t.jsxs("div",{className:"flex items-center gap-1 text-white text-sm",children:[t.jsx(_e,{className:"h-4 w-4"}),t.jsx("span",{children:K.length+1})]}),t.jsx(u,{variant:"ghost",size:"icon",onClick:ve,className:"text-white",children:F?t.jsx(Ue,{className:"h-4 w-4"}):t.jsx(Oe,{className:"h-4 w-4"})})]})]}),t.jsx("div",{className:"flex-1 p-4 overflow-auto",children:t.jsx("div",{className:`grid gap-4 h-full ${S.length===1?"grid-cols-1":S.length===2||S.length<=4?"grid-cols-2":"grid-cols-3"}`,children:S.map(e=>{const s=ye(e.name),a=e.stream&&e.stream.getVideoTracks().length>0&&e.stream.getVideoTracks()[0].enabled;return t.jsxs("div",{className:"relative bg-gray-800 rounded-2xl overflow-hidden shadow-2xl group min-h-[200px]",children:[a?t.jsx("video",{ref:e.isLocal?k:void 0,autoPlay:!0,muted:e.isLocal,playsInline:!0,className:"w-full h-full object-cover"}):t.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-700 to-gray-900",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:`${s} text-white rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-4`,children:t.jsx("span",{className:"text-4xl font-bold",children:e.name[0]?.toUpperCase()})}),t.jsx("p",{className:"text-white text-lg font-medium",children:e.name})]})}),t.jsxs("div",{className:"absolute bottom-4 left-4 right-4 flex items-center justify-between",children:[t.jsxs("div",{className:"bg-black/50 backdrop-blur-sm rounded-lg px-3 py-1 flex items-center gap-2 text-white text-sm",children:[t.jsx(Ee,{className:"h-4 w-4"}),e.name,e.isLocal&&t.jsx("span",{className:"text-xs opacity-70",children:"(Êàë)"})]}),t.jsxs("div",{className:"flex gap-1",children:[e.isLocal&&v&&t.jsx("div",{className:"bg-red-500 rounded-full p-1",children:t.jsx(te,{className:"h-3 w-3 text-white"})}),e.isLocal&&!j&&t.jsx("div",{className:"bg-yellow-500 rounded-full p-1",children:t.jsx(se,{className:"h-3 w-3 text-white"})})]})]})]},e.id)})})}),t.jsxs("footer",{className:`h-24 bg-black/50 backdrop-blur-xl flex items-center justify-center gap-4 transition-all ${H?"translate-y-0":"translate-y-full"}`,children:[t.jsx(u,{variant:v?"destructive":"secondary",size:"lg",className:"rounded-full w-14 h-14",onClick:ge,children:v?t.jsx(te,{className:"h-6 w-6"}):t.jsx(Ie,{className:"h-6 w-6"})}),t.jsx(u,{variant:j?"secondary":"destructive",size:"lg",className:"rounded-full w-14 h-14",onClick:we,children:j?t.jsx(Ve,{className:"h-6 w-6"}):t.jsx(se,{className:"h-6 w-6"})}),t.jsx(u,{variant:"destructive",size:"lg",className:"rounded-full w-14 h-14",onClick:ee,children:t.jsx(qe,{className:"h-6 w-6"})}),t.jsx(u,{variant:P?"default":"secondary",size:"lg",className:"rounded-full w-14 h-14",onClick:Z,children:t.jsx($e,{className:"h-6 w-6"})}),t.jsxs("div",{className:"absolute right-4 flex items-center gap-2 text-white text-sm",children:[t.jsx(Ae,{className:"h-4 w-4"}),ke(ie)]})]})]})}export{et as default};

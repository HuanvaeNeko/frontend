import{c as f,n as j,a as u,l as U}from"./index-DW35rIVo.js";const P=[["path",{d:"M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z",key:"1vdc57"}],["path",{d:"M5 21h14",key:"11awu3"}]],H=f("crown",P);const N=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],D=f("ellipsis-vertical",N);const v=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]],F=f("file-text",v);const x=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],C=f("image",x);const z=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],W=f("paperclip",z);const J=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],q=f("trash-2",J),c=`${j()}/api/groups`,A=()=>{const r=u.getState().accessToken;return{"Content-Type":"application/json",...r?{Authorization:`Bearer ${r}`}:{}}},i=async(r,o={})=>{const e=u.getState();if(e.checkTokenExpiry()&&e.refreshToken)try{await e.refreshAccessToken()}catch(n){console.error("Failed to refresh token:",n)}const t=A();let s=await fetch(r,{...o,headers:{...t,...o.headers}});if(s.status===401&&e.refreshToken)try{await e.refreshAccessToken();const n=A();s=await fetch(r,{...o,headers:{...n,...o.headers}})}catch(n){throw console.error("Token refresh failed, redirecting to login"),e.clearAuth(),window.location.href="/login",n}return s},p={createGroup:async r=>{console.log("âž• åˆ›å»ºç¾¤èŠ:",r.group_name);const o=await i(`${c}`,{method:"POST",body:JSON.stringify(r)});if(!o.ok){const t=await o.json().catch(()=>({error:"åˆ›å»ºç¾¤èŠå¤±è´¥"}));throw new Error(t.error||"åˆ›å»ºç¾¤èŠå¤±è´¥")}const e=await o.json();return console.log("âœ… ç¾¤èŠåˆ›å»ºæˆåŠŸ:",e.data.group_id),e.data},getMyGroups:async()=>{console.log("ðŸ“‹ èŽ·å–æˆ‘çš„ç¾¤èŠåˆ—è¡¨");const r=await i(`${c}/my`,{method:"GET"});if(!r.ok){const t=await r.json().catch(()=>({error:"èŽ·å–ç¾¤èŠåˆ—è¡¨å¤±è´¥"}));throw new Error(t.error||"èŽ·å–ç¾¤èŠåˆ—è¡¨å¤±è´¥")}const o=await r.json();console.log("ðŸ“‹ ç¾¤èŠåˆ—è¡¨å“åº”:",o);const e=o.data?.groups||o.data||o.groups||o||[];return Array.isArray(e)?e:[]},searchGroups:async r=>{console.log("ðŸ” æœç´¢ç¾¤èŠ:",r);const o=new URLSearchParams({query:r}),e=await i(`${c}/search?${o}`,{method:"GET"});if(!e.ok){const s=await e.json().catch(()=>({error:"æœç´¢ç¾¤èŠå¤±è´¥"}));throw new Error(s.error||"æœç´¢ç¾¤èŠå¤±è´¥")}return(await e.json()).data||[]},getGroupDetail:async r=>{console.log("â„¹ï¸ èŽ·å–ç¾¤èŠè¯¦æƒ…:",r);const o=await i(`${c}/${r}`,{method:"GET"});if(!o.ok){const t=await o.json().catch(()=>({error:"èŽ·å–ç¾¤èŠè¯¦æƒ…å¤±è´¥"}));throw new Error(t.error||"èŽ·å–ç¾¤èŠè¯¦æƒ…å¤±è´¥")}return(await o.json()).data},updateGroup:async(r,o)=>{console.log("âœï¸ æ›´æ–°ç¾¤èŠä¿¡æ¯:",r);const e=await i(`${c}/${r}`,{method:"PUT",body:JSON.stringify(o)});if(!e.ok){const t=await e.json().catch(()=>({error:"æ›´æ–°ç¾¤èŠä¿¡æ¯å¤±è´¥"}));throw new Error(t.error||"æ›´æ–°ç¾¤èŠä¿¡æ¯å¤±è´¥")}console.log("âœ… ç¾¤èŠä¿¡æ¯æ›´æ–°æˆåŠŸ")},uploadGroupAvatar:async(r,o)=>{console.log("ðŸ“¸ ä¸Šä¼ ç¾¤å¤´åƒ:",r,o.name);const e=10*1024*1024;if(o.size>e)throw new Error(`æ–‡ä»¶å¤ªå¤§ï¼Œæœ€å¤§ 10MBï¼Œå½“å‰: ${(o.size/1024/1024).toFixed(2)} MB`);if(!["image/jpeg","image/png","image/gif","image/webp"].includes(o.type))throw new Error("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œæ”¯æŒ: jpg, jpeg, png, gif, webp");const s=new FormData;s.append("avatar",o);const a=u.getState().accessToken,l=await fetch(`${c}/${r}/avatar`,{method:"POST",headers:{...a?{Authorization:`Bearer ${a}`}:{}},body:s});if(!l.ok){const y=await l.json().catch(()=>({error:"ä¸Šä¼ ç¾¤å¤´åƒå¤±è´¥"}));throw new Error(y.error||"ä¸Šä¼ ç¾¤å¤´åƒå¤±è´¥")}const h=await l.json();return console.log("âœ… ç¾¤å¤´åƒä¸Šä¼ æˆåŠŸ:",h.data.avatar_url),h.data},updateGroupNickname:async(r,o)=>{console.log("âœï¸ ä¿®æ”¹ç¾¤å†…æ˜µç§°:",r,o);const e=await i(`${c}/${r}/nickname`,{method:"PUT",body:JSON.stringify({nickname:o})});if(!e.ok){const t=await e.json().catch(()=>({error:"ä¿®æ”¹ç¾¤å†…æ˜µç§°å¤±è´¥"}));throw new Error(t.error||"ä¿®æ”¹ç¾¤å†…æ˜µç§°å¤±è´¥")}console.log("âœ… ç¾¤å†…æ˜µç§°ä¿®æ”¹æˆåŠŸ")},updateJoinMode:async(r,o)=>{console.log("ðŸ”’ ä¿®æ”¹å…¥ç¾¤æ¨¡å¼:",r,o);const e=await i(`${c}/${r}/join-mode`,{method:"PUT",body:JSON.stringify({join_mode:o})});if(!e.ok){const t=await e.json().catch(()=>({error:"ä¿®æ”¹å…¥ç¾¤æ¨¡å¼å¤±è´¥"}));throw new Error(t.error||"ä¿®æ”¹å…¥ç¾¤æ¨¡å¼å¤±è´¥")}console.log("âœ… å…¥ç¾¤æ¨¡å¼ä¿®æ”¹æˆåŠŸ")},disbandGroup:async r=>{console.log("ðŸ—‘ï¸ è§£æ•£ç¾¤èŠ:",r);const o=await i(`${c}/${r}`,{method:"DELETE"});if(!o.ok){const e=await o.json().catch(()=>({error:"è§£æ•£ç¾¤èŠå¤±è´¥"}));throw new Error(e.error||"è§£æ•£ç¾¤èŠå¤±è´¥")}console.log("âœ… ç¾¤èŠå·²è§£æ•£")},getMembers:async r=>{console.log("ðŸ‘¥ èŽ·å–æˆå‘˜åˆ—è¡¨:",r);const o=await i(`${c}/${r}/members`,{method:"GET"});if(!o.ok){const n=await o.json().catch(()=>({error:"èŽ·å–æˆå‘˜åˆ—è¡¨å¤±è´¥"}));throw new Error(n.error||"èŽ·å–æˆå‘˜åˆ—è¡¨å¤±è´¥")}const e=await o.json();console.log("ðŸ‘¥ æˆå‘˜åˆ—è¡¨å“åº”:",e);const t=e.data||e||{},s=t.members||[];return{members:Array.isArray(s)?s:[],total:t.total||s.length||0}},inviteMembers:async(r,o,e)=>{console.log("ðŸ“© é‚€è¯·æˆå‘˜å…¥ç¾¤:",r,o);const t=await i(`${c}/${r}/invite`,{method:"POST",body:JSON.stringify({user_ids:o,message:e})});if(!t.ok){const n=await t.json().catch(()=>({error:"é‚€è¯·æˆå‘˜å¤±è´¥"}));throw new Error(n.error||"é‚€è¯·æˆå‘˜å¤±è´¥")}const s=await t.json();return console.log("âœ… é‚€è¯·å·²å‘é€"),s.data},leaveGroup:async(r,o)=>{console.log("ðŸšª é€€å‡ºç¾¤èŠ:",r);const e=await i(`${c}/${r}/leave`,{method:"POST",body:JSON.stringify({reason:o})});if(!e.ok){const t=await e.json().catch(()=>({error:"é€€å‡ºç¾¤èŠå¤±è´¥"}));throw new Error(t.error||"é€€å‡ºç¾¤èŠå¤±è´¥")}console.log("âœ… å·²é€€å‡ºç¾¤èŠ")},removeMember:async(r,o)=>{console.log("ðŸš« ç§»é™¤æˆå‘˜:",r,o);const e=await i(`${c}/${r}/members/${o}`,{method:"DELETE"});if(!e.ok){const t=await e.json().catch(()=>({error:"ç§»é™¤æˆå‘˜å¤±è´¥"}));throw new Error(t.error||"ç§»é™¤æˆå‘˜å¤±è´¥")}console.log("âœ… æˆå‘˜å·²ç§»é™¤")},transferOwner:async(r,o)=>{console.log("ðŸ‘‘ è½¬è®©ç¾¤ä¸»:",r,o);const e=await i(`${c}/${r}/transfer`,{method:"POST",body:JSON.stringify({new_owner_id:o})});if(!e.ok){const t=await e.json().catch(()=>({error:"è½¬è®©ç¾¤ä¸»å¤±è´¥"}));throw new Error(t.error||"è½¬è®©ç¾¤ä¸»å¤±è´¥")}console.log("âœ… ç¾¤ä¸»å·²è½¬è®©")},setAdmin:async(r,o)=>{console.log("â¬†ï¸ è®¾ç½®ç®¡ç†å‘˜:",r,o);const e=await i(`${c}/${r}/admins`,{method:"POST",body:JSON.stringify({user_id:o})});if(!e.ok){const t=await e.json().catch(()=>({error:"è®¾ç½®ç®¡ç†å‘˜å¤±è´¥"}));throw new Error(t.error||"è®¾ç½®ç®¡ç†å‘˜å¤±è´¥")}console.log("âœ… å·²è®¾ç½®ä¸ºç®¡ç†å‘˜")},removeAdmin:async(r,o)=>{console.log("â¬‡ï¸ å–æ¶ˆç®¡ç†å‘˜:",r,o);const e=await i(`${c}/${r}/admins/${o}`,{method:"DELETE"});if(!e.ok){const t=await e.json().catch(()=>({error:"å–æ¶ˆç®¡ç†å‘˜å¤±è´¥"}));throw new Error(t.error||"å–æ¶ˆç®¡ç†å‘˜å¤±è´¥")}console.log("âœ… å·²å–æ¶ˆç®¡ç†å‘˜")},muteMember:async(r,o,e)=>{console.log("ðŸ”‡ ç¦è¨€æˆå‘˜:",r,o,e,"åˆ†é’Ÿ");const t=await i(`${c}/${r}/mute`,{method:"POST",body:JSON.stringify({user_id:o,duration_minutes:e})});if(!t.ok){const n=await t.json().catch(()=>({error:"ç¦è¨€å¤±è´¥"}));throw new Error(n.error||"ç¦è¨€å¤±è´¥")}const s=await t.json();return console.log("âœ… å·²ç¦è¨€"),s.data},unmuteMember:async(r,o)=>{console.log("ðŸ”Š è§£é™¤ç¦è¨€:",r,o);const e=await i(`${c}/${r}/mute/${o}`,{method:"DELETE"});if(!e.ok){const t=await e.json().catch(()=>({error:"è§£é™¤ç¦è¨€å¤±è´¥"}));throw new Error(t.error||"è§£é™¤ç¦è¨€å¤±è´¥")}console.log("âœ… å·²è§£é™¤ç¦è¨€")},createInviteCode:async(r,o)=>{console.log("ðŸ”— ç”Ÿæˆé‚€è¯·ç :",r);const e=await i(`${c}/${r}/invite-codes`,{method:"POST",body:JSON.stringify(o||{})});if(!e.ok){const s=await e.json().catch(()=>({error:"ç”Ÿæˆé‚€è¯·ç å¤±è´¥"}));throw new Error(s.error||"ç”Ÿæˆé‚€è¯·ç å¤±è´¥")}const t=await e.json();return console.log("âœ… é‚€è¯·ç ç”ŸæˆæˆåŠŸ:",t.data.code),t.data},getInviteCodes:async r=>{console.log("ðŸ“‹ èŽ·å–é‚€è¯·ç åˆ—è¡¨:",r);const o=await i(`${c}/${r}/invite-codes`,{method:"GET"});if(!o.ok){const t=await o.json().catch(()=>({error:"èŽ·å–é‚€è¯·ç åˆ—è¡¨å¤±è´¥"}));throw new Error(t.error||"èŽ·å–é‚€è¯·ç åˆ—è¡¨å¤±è´¥")}return(await o.json()).data||[]},revokeInviteCode:async(r,o)=>{console.log("ðŸ—‘ï¸ æ’¤é”€é‚€è¯·ç :",r,o);const e=await i(`${c}/${r}/invite-codes/${o}`,{method:"DELETE"});if(!e.ok){const t=await e.json().catch(()=>({error:"æ’¤é”€é‚€è¯·ç å¤±è´¥"}));throw new Error(t.error||"æ’¤é”€é‚€è¯·ç å¤±è´¥")}console.log("âœ… é‚€è¯·ç å·²æ’¤é”€")},joinByCode:async r=>{console.log("ðŸ”— é€šè¿‡é‚€è¯·ç å…¥ç¾¤:",r);const o=await i(`${c}/join-by-code`,{method:"POST",body:JSON.stringify({code:r})});if(!o.ok){const e=await o.json().catch(()=>({error:"å…¥ç¾¤å¤±è´¥"}));throw new Error(e.error||"å…¥ç¾¤å¤±è´¥")}console.log("âœ… å·²æˆåŠŸåŠ å…¥ç¾¤èŠ")},applyToJoin:async(r,o)=>{console.log("ðŸ“ ç”³è¯·å…¥ç¾¤:",r);const e=await i(`${c}/${r}/apply`,{method:"POST",body:JSON.stringify({message:o})});if(!e.ok){const t=await e.json().catch(()=>({error:"ç”³è¯·å…¥ç¾¤å¤±è´¥"}));throw new Error(t.error||"ç”³è¯·å…¥ç¾¤å¤±è´¥")}console.log("âœ… ç”³è¯·å·²æäº¤")},getInvitations:async()=>{console.log("ðŸ“¬ èŽ·å–æ”¶åˆ°çš„é‚€è¯·");const r=await i(`${c}/invitations`,{method:"GET"});if(!r.ok){const e=await r.json().catch(()=>({error:"èŽ·å–é‚€è¯·å¤±è´¥"}));throw new Error(e.error||"èŽ·å–é‚€è¯·å¤±è´¥")}return(await r.json()).data?.invitations||[]},acceptInvitation:async r=>{console.log("âœ… æŽ¥å—é‚€è¯·:",r);const o=await i(`${c}/invitations/${r}/accept`,{method:"POST"});if(!o.ok){const e=await o.json().catch(()=>({error:"æŽ¥å—é‚€è¯·å¤±è´¥"}));throw new Error(e.error||"æŽ¥å—é‚€è¯·å¤±è´¥")}console.log("âœ… å·²æŽ¥å—é‚€è¯·")},declineInvitation:async r=>{console.log("âŒ æ‹’ç»é‚€è¯·:",r);const o=await i(`${c}/invitations/${r}/decline`,{method:"POST"});if(!o.ok){const e=await o.json().catch(()=>({error:"æ‹’ç»é‚€è¯·å¤±è´¥"}));throw new Error(e.error||"æ‹’ç»é‚€è¯·å¤±è´¥")}console.log("âœ… å·²æ‹’ç»é‚€è¯·")},getJoinRequests:async r=>{console.log("ðŸ“‹ èŽ·å–å¾…å¤„ç†ç”³è¯·:",r);const o=await i(`${c}/${r}/requests`,{method:"GET"});if(!o.ok){const t=await o.json().catch(()=>({error:"èŽ·å–ç”³è¯·å¤±è´¥"}));throw new Error(t.error||"èŽ·å–ç”³è¯·å¤±è´¥")}return(await o.json()).data||[]},approveJoinRequest:async(r,o)=>{console.log("âœ… åŒæ„ç”³è¯·:",r,o);const e=await i(`${c}/${r}/requests/${o}/approve`,{method:"POST"});if(!e.ok){const t=await e.json().catch(()=>({error:"åŒæ„ç”³è¯·å¤±è´¥"}));throw new Error(t.error||"åŒæ„ç”³è¯·å¤±è´¥")}console.log("âœ… ç”³è¯·å·²åŒæ„")},rejectJoinRequest:async(r,o,e)=>{console.log("âŒ æ‹’ç»ç”³è¯·:",r,o);const t=await i(`${c}/${r}/requests/${o}/reject`,{method:"POST",body:JSON.stringify({reason:e})});if(!t.ok){const s=await t.json().catch(()=>({error:"æ‹’ç»ç”³è¯·å¤±è´¥"}));throw new Error(s.error||"æ‹’ç»ç”³è¯·å¤±è´¥")}console.log("âœ… ç”³è¯·å·²æ‹’ç»")},createNotice:async(r,o)=>{console.log("ðŸ“¢ å‘å¸ƒå…¬å‘Š:",r);const e=await i(`${c}/${r}/notices`,{method:"POST",body:JSON.stringify(o)});if(!e.ok){const s=await e.json().catch(()=>({error:"å‘å¸ƒå…¬å‘Šå¤±è´¥"}));throw new Error(s.error||"å‘å¸ƒå…¬å‘Šå¤±è´¥")}const t=await e.json();return console.log("âœ… å…¬å‘Šå‘å¸ƒæˆåŠŸ"),t.data},getNotices:async r=>{console.log("ðŸ“‹ èŽ·å–å…¬å‘Šåˆ—è¡¨:",r);const o=await i(`${c}/${r}/notices`,{method:"GET"});if(!o.ok){const s=await o.json().catch(()=>({error:"èŽ·å–å…¬å‘Šå¤±è´¥"}));throw new Error(s.error||"èŽ·å–å…¬å‘Šå¤±è´¥")}const e=await o.json();console.log("ðŸ“‹ å…¬å‘Šåˆ—è¡¨å“åº”:",e);const t=e.data?.notices||e.data||e.notices||e||[];return Array.isArray(t)?t:[]},updateNotice:async(r,o,e)=>{console.log("âœï¸ æ›´æ–°å…¬å‘Š:",r,o);const t=await i(`${c}/${r}/notices/${o}`,{method:"PUT",body:JSON.stringify(e)});if(!t.ok){const s=await t.json().catch(()=>({error:"æ›´æ–°å…¬å‘Šå¤±è´¥"}));throw new Error(s.error||"æ›´æ–°å…¬å‘Šå¤±è´¥")}console.log("âœ… å…¬å‘Šæ›´æ–°æˆåŠŸ")},deleteNotice:async(r,o)=>{console.log("ðŸ—‘ï¸ åˆ é™¤å…¬å‘Š:",r,o);const e=await i(`${c}/${r}/notices/${o}`,{method:"DELETE"});if(!e.ok){const t=await e.json().catch(()=>({error:"åˆ é™¤å…¬å‘Šå¤±è´¥"}));throw new Error(t.error||"åˆ é™¤å…¬å‘Šå¤±è´¥")}console.log("âœ… å…¬å‘Šå·²åˆ é™¤")}},V=U((r,o)=>({myGroups:[],selectedGroup:null,currentGroupMembers:[],currentGroupNotices:[],isLoading:!1,error:null,loadMyGroups:async()=>{r({isLoading:!0,error:null});try{const e=await p.getMyGroups();r({myGroups:e,isLoading:!1})}catch(e){const t=e instanceof Error?e.message:"åŠ è½½ç¾¤èŠåˆ—è¡¨å¤±è´¥";throw r({error:t,isLoading:!1}),e}},loadGroupMembers:async e=>{r({isLoading:!0,error:null});try{const t=await p.getMembers(e);r({currentGroupMembers:t.members,isLoading:!1})}catch(t){const s=t instanceof Error?t.message:"åŠ è½½ç¾¤æˆå‘˜å¤±è´¥";throw r({error:s,isLoading:!1}),t}},loadGroupNotices:async e=>{r({isLoading:!0,error:null});try{const t=await p.getNotices(e);r({currentGroupNotices:t,isLoading:!1})}catch(t){const s=t instanceof Error?t.message:"åŠ è½½ç¾¤å…¬å‘Šå¤±è´¥";throw r({error:s,isLoading:!1}),t}},selectGroup:e=>{r({selectedGroup:e}),e?(o().loadGroupMembers(e.group_id).catch(console.error),o().loadGroupNotices(e.group_id).catch(console.error)):r({currentGroupMembers:[],currentGroupNotices:[]})},createGroup:async(e,t,s)=>{r({isLoading:!0,error:null});try{const n=await p.createGroup({group_name:e,group_description:t,join_mode:s});return await o().loadMyGroups(),r({isLoading:!1}),n}catch(n){const a=n instanceof Error?n.message:"åˆ›å»ºç¾¤èŠå¤±è´¥";throw r({error:a,isLoading:!1}),n}},searchGroups:async e=>{r({isLoading:!0,error:null});try{const t=await p.searchGroups(e);return r({isLoading:!1}),t}catch(t){const s=t instanceof Error?t.message:"æœç´¢ç¾¤èŠå¤±è´¥";throw r({error:s,isLoading:!1}),t}},updateGroup:async(e,t)=>{r({isLoading:!0,error:null});try{await p.updateGroup(e,{group_name:t.group_name,group_description:t.group_description,group_avatar_url:t.group_avatar_url}),await o().loadMyGroups(),r({isLoading:!1})}catch(s){const n=s instanceof Error?s.message:"æ›´æ–°ç¾¤ä¿¡æ¯å¤±è´¥";throw r({error:n,isLoading:!1}),s}},clearError:()=>{r({error:null})}})),T=`${j()}/api/group-messages`,M=()=>{const r=u.getState().accessToken;return{"Content-Type":"application/json",...r?{Authorization:`Bearer ${r}`}:{}}},S=async(r,o={})=>{const e=u.getState();if(e.checkTokenExpiry()&&e.refreshToken)try{await e.refreshAccessToken()}catch(n){console.error("Failed to refresh token:",n)}const t=M();let s=await fetch(r,{...o,headers:{...t,...o.headers}});if(s.status===401&&e.refreshToken)try{await e.refreshAccessToken();const n=M();s=await fetch(r,{...o,headers:{...n,...o.headers}})}catch(n){throw console.error("Token refresh failed, redirecting to login"),e.clearAuth(),window.location.href="/login",n}return s},L={sendMessage:async r=>{console.log("ðŸ“¤ å‘é€ç¾¤æ¶ˆæ¯:",r.group_id);const o=await S(`${T}`,{method:"POST",body:JSON.stringify(r)});if(!o.ok){const t=await o.json().catch(()=>({error:"å‘é€ç¾¤æ¶ˆæ¯å¤±è´¥"}));throw console.error("å‘é€ç¾¤æ¶ˆæ¯å¤±è´¥:",t),new Error(t.error||"å‘é€ç¾¤æ¶ˆæ¯å¤±è´¥")}const e=await o.json();return console.log("âœ… ç¾¤æ¶ˆæ¯å‘é€æˆåŠŸ:",e.data.message_uuid),e.data},getMessages:async(r,o,e=50)=>{console.log("ðŸ“¥ èŽ·å–ç¾¤æ¶ˆæ¯åˆ—è¡¨:",r);const t=new URLSearchParams({group_id:r,limit:e.toString()});o&&t.set("before_time",o);const s=await S(`${T}?${t}`,{method:"GET"});if(!s.ok){const a=await s.json().catch(()=>({error:"èŽ·å–ç¾¤æ¶ˆæ¯å¤±è´¥"}));throw console.error("èŽ·å–ç¾¤æ¶ˆæ¯å¤±è´¥:",a),new Error(a.error||"èŽ·å–ç¾¤æ¶ˆæ¯å¤±è´¥")}return(await s.json()).data},deleteMessage:async r=>{console.log("ðŸ—‘ï¸ åˆ é™¤ç¾¤æ¶ˆæ¯:",r);const o=await S(`${T}/delete`,{method:"DELETE",body:JSON.stringify({message_uuid:r})});if(!o.ok){const t=await o.json().catch(()=>({error:"åˆ é™¤ç¾¤æ¶ˆæ¯å¤±è´¥"}));throw console.error("åˆ é™¤ç¾¤æ¶ˆæ¯å¤±è´¥:",t),new Error(t.error||"åˆ é™¤ç¾¤æ¶ˆæ¯å¤±è´¥")}const e=await o.json();return console.log("âœ… ç¾¤æ¶ˆæ¯åˆ é™¤æˆåŠŸ"),e.data},recallMessage:async r=>{console.log("â†©ï¸ æ’¤å›žç¾¤æ¶ˆæ¯:",r);const o=await S(`${T}/recall`,{method:"POST",body:JSON.stringify({message_uuid:r})});if(!o.ok){const t=await o.json().catch(()=>({error:"æ’¤å›žç¾¤æ¶ˆæ¯å¤±è´¥"}));throw console.error("æ’¤å›žç¾¤æ¶ˆæ¯å¤±è´¥:",t),new Error(t.error||"æ’¤å›žç¾¤æ¶ˆæ¯å¤±è´¥")}const e=await o.json();return console.log("âœ… ç¾¤æ¶ˆæ¯æ’¤å›žæˆåŠŸ"),e.data},loadMoreMessages:async(r,o,e=50)=>{if(o.length===0)return L.getMessages(r,void 0,e);const t=o[o.length-1].send_time;return L.getMessages(r,t,e)}},d=`${j()}/api/storage`,b=()=>{const r=u.getState().accessToken;return{"Content-Type":"application/json",...r?{Authorization:`Bearer ${r}`}:{}}},g=async(r,o={})=>{const e=u.getState();if(e.checkTokenExpiry()&&e.refreshToken)try{await e.refreshAccessToken()}catch(n){console.error("Failed to refresh token:",n)}const t=b();let s=await fetch(r,{...o,headers:{...t,...o.headers}});if(s.status===401&&e.refreshToken)try{await e.refreshAccessToken();const n=b();s=await fetch(r,{...o,headers:{...n,...o.headers}})}catch(n){throw console.error("Token refresh failed, redirecting to login"),e.clearAuth(),window.location.href="/login",n}return s},m=10*1024*1024;async function R(r){const o=new TextEncoder().encode(`|size:${r.size}|`);let e;if(r.size<=m*3){const a=new Uint8Array(await r.arrayBuffer());e=new Uint8Array(o.length+a.length),e.set(o,0),e.set(a,o.length)}else{const a=[],l=r.slice(0,m);a.push(new Uint8Array(await l.arrayBuffer()));const h=Math.floor((r.size-m)/2),y=r.slice(h,h+m);a.push(new Uint8Array(await y.arrayBuffer()));const $=r.slice(r.size-m,r.size);a.push(new Uint8Array(await $.arrayBuffer()));const O=o.length+a.reduce((_,G)=>_+G.length,0);e=new Uint8Array(O);let E=0;e.set(o,E),E+=o.length;for(const _ of a)e.set(_,E),E+=_.length}const t=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map(a=>a.toString(16).padStart(2,"0")).join("")}function K(r){return r<1024?r+" B":r<1024*1024?(r/1024).toFixed(2)+" KB":r<1024*1024*1024?(r/1024/1024).toFixed(2)+" MB":(r/1024/1024/1024).toFixed(2)+" GB"}const w={},k={requestUpload:async r=>{console.log("ðŸ“¤ è¯·æ±‚ä¸Šä¼ :",r.filename);const o=await g(`${d}/upload/request`,{method:"POST",body:JSON.stringify(r)});if(!o.ok){const t=await o.json().catch(()=>({error:"è¯·æ±‚ä¸Šä¼ å¤±è´¥"}));throw new Error(t.error||"è¯·æ±‚ä¸Šä¼ å¤±è´¥")}const e=await o.json();return e.instant_upload&&console.log("âš¡ ç§’ä¼ æˆåŠŸ!"),e},getPartUrl:async(r,o,e)=>{const t=new URLSearchParams({file_key:r,upload_id:o,part_number:e.toString()}),s=await g(`${d}/multipart/part_url?${t}`,{method:"GET"});if(!s.ok){const n=await s.json().catch(()=>({error:"èŽ·å–åˆ†ç‰‡URLå¤±è´¥"}));throw new Error(n.error||"èŽ·å–åˆ†ç‰‡URLå¤±è´¥")}return await s.json()},uploadChunk:async(r,o)=>new Promise((e,t)=>{const s=new XMLHttpRequest;s.onload=()=>{s.status>=200&&s.status<300?e():t(new Error(`åˆ†ç‰‡ä¸Šä¼ å¤±è´¥: HTTP ${s.status}`))},s.onerror=()=>t(new Error("ç½‘ç»œé”™è¯¯")),s.open("PUT",r),s.send(o)}),uploadWithMultipart:async(r,o,e)=>{const t=o.chunk_size||31457280,s=o.total_chunks||Math.ceil(r.size/t);let n=0;for(let a=0;a<s;a++){const{part_url:l}=await k.getPartUrl(o.file_key,o.multipart_upload_id,a+1),h=a*t,y=Math.min(h+t,r.size),$=r.slice(h,y);await k.uploadChunk(l,$),n+=$.size,e&&e({percent:n/r.size*100,loaded:n,total:r.size,currentChunk:a+1,totalChunks:s})}},confirmUpload:async r=>{console.log("âœ… ç¡®è®¤ä¸Šä¼ å®Œæˆ:",r);const o=await g(`${d}/upload/confirm`,{method:"POST",body:JSON.stringify({file_key:r})});if(!o.ok){const t=await o.json().catch(()=>({error:"ç¡®è®¤ä¸Šä¼ å¤±è´¥"}));throw new Error(t.error||"ç¡®è®¤ä¸Šä¼ å¤±è´¥")}const e=await o.json();return console.log("âœ… ä¸Šä¼ ç¡®è®¤æˆåŠŸ"),e},uploadFile:async(r,o,e,t,s)=>{console.log("ðŸ”„ å¼€å§‹ä¸Šä¼ æµç¨‹:",r.name),console.log("ðŸ”¢ è®¡ç®—æ–‡ä»¶å“ˆå¸Œ...");const n=await R(r),a=await k.requestUpload({file_type:o,storage_location:e,related_id:t,filename:r.name,file_size:r.size,content_type:r.type,file_hash:n,force_upload:!1});if(a.instant_upload)return console.log("âš¡ ç§’ä¼ æˆåŠŸ!"),{fileUrl:a.existing_file_url,isInstant:!0,messageUuid:a.message_uuid};console.log(`ðŸ“¤ å¼€å§‹åˆ†ç‰‡ä¸Šä¼ : ${a.total_chunks} ä¸ªåˆ†ç‰‡`),await k.uploadWithMultipart(r,a,s),console.log("âœ… ç¡®è®¤ä¸Šä¼ ...");const l=await k.confirmUpload(a.file_key);return console.log("âœ… ä¸Šä¼ æˆåŠŸ!"),{fileUrl:l.file_url,isInstant:!1,messageUuid:l.message_uuid}},getPresignedUrl:async(r,o="download")=>{const e=w[r];if(e&&e.expiresAt){const n=new Date(e.expiresAt),a=new Date;if(n.getTime()-a.getTime()>300*1e3)return console.log("âœ… ä½¿ç”¨ç¼“å­˜çš„é¢„ç­¾åURL"),e.url}console.log("ðŸ”— èŽ·å–é¢„ç­¾åURL:",r);const t=await g(`${d}/file/${r}/presigned_url`,{method:"POST",body:JSON.stringify({operation:o})});if(!t.ok){const n=await t.json().catch(()=>({error:"èŽ·å–é¢„ç­¾åURLå¤±è´¥"}));throw new Error(n.error||"èŽ·å–é¢„ç­¾åURLå¤±è´¥")}const s=await t.json();return w[r]={url:s.presigned_url,expiresAt:s.expires_at,cachedAt:new Date().toISOString()},s.warning&&console.warn("âš ï¸",s.warning),s.presigned_url},getExtendedPresignedUrl:async(r,o)=>{console.log("ðŸ”— èŽ·å–æ‰©å±•é¢„ç­¾åURL:",r);const e=await g(`${d}/file/${r}/presigned_url/extended`,{method:"POST",body:JSON.stringify({operation:"download",estimated_download_time:o})});if(!e.ok){const s=await e.json().catch(()=>({error:"èŽ·å–æ‰©å±•é¢„ç­¾åURLå¤±è´¥"}));throw new Error(s.error||"èŽ·å–æ‰©å±•é¢„ç­¾åURLå¤±è´¥")}const t=await e.json();return t.warning&&console.warn("âš ï¸",t.warning),t.presigned_url},getFriendFilePresignedUrl:async(r,o="preview")=>{const e=`friend_${r}`,t=w[e];if(t&&t.expiresAt){const a=new Date(t.expiresAt),l=new Date;if(a.getTime()-l.getTime()>300*1e3)return console.log("âœ… ä½¿ç”¨ç¼“å­˜çš„å¥½å‹æ–‡ä»¶é¢„ç­¾åURL"),t.url}console.log("ðŸ”— èŽ·å–å¥½å‹æ–‡ä»¶é¢„ç­¾åURL:",r);const s=await g(`${d}/friends-file/${r}/presigned-url`,{method:"POST",body:JSON.stringify({operation:o})});if(!s.ok){const a=await s.json().catch(()=>({error:"èŽ·å–å¥½å‹æ–‡ä»¶é¢„ç­¾åURLå¤±è´¥"}));throw new Error(a.error||"èŽ·å–å¥½å‹æ–‡ä»¶é¢„ç­¾åURLå¤±è´¥")}const n=await s.json();return w[e]={url:n.presigned_url,expiresAt:n.expires_at,cachedAt:new Date().toISOString()},n.presigned_url},getFileList:async(r=1,o=20,e="created_at",t="desc")=>{console.log("ðŸ“‹ èŽ·å–æ–‡ä»¶åˆ—è¡¨");const s=new URLSearchParams({page:r.toString(),limit:o.toString(),sort_by:e,sort_order:t}),n=await g(`${d}/files?${s}`,{method:"GET"});if(!n.ok){const l=await n.json().catch(()=>({error:"èŽ·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥"}));throw new Error(l.error||"èŽ·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥")}return await n.json()},clearPresignedUrlCache:r=>{r?(delete w[r],delete w[`friend_${r}`]):Object.keys(w).forEach(o=>delete w[o])}};export{H as C,D as E,F,C as I,W as P,q as T,L as a,K as f,p as g,k as s,V as u};

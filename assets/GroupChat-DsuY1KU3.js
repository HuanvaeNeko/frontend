import{u as Te,q as Re,o as Fe,a as Ee,r as a,j as e,h as l,X as Ie}from"./index-DW35rIVo.js";import{I as Ae}from"./input-f5AW0FoI.js";import{A as I,a as A,b as D}from"./avatar-BGq7Gosz.js";import{R as te,T as re,P as ae,C as ne,I as y,S as De,L as ie}from"./index-1jbiq5kt.js";import{u as Ge,a as j,g as G,E as Le,T as Pe,I as le,F as ce,P as Be,s as Ue,C as $e}from"./storage-UW3RZwoa.js";import{U as L}from"./users-BN-OU-3M.js";import{A as Oe}from"./arrow-left-DY4_iDT3.js";import{S as We}from"./settings-CSPE_HBJ.js";import{B as Ke,R as Ve,S as qe}from"./shield-zGZ-pXQF.js";import{L as C}from"./loader-circle-BnlNvwYj.js";import{V as oe}from"./video-D47MdYhU.js";import{S as He,D as Xe}from"./send-B5Dqmo0T.js";import{U as Je}from"./user-plus-DBDwmKt9.js";import"./index-MnEzf-Ac.js";import"./index-D2xAthOw.js";import"./index-DN7uoSTJ.js";import"./index-DUzm_Fz5.js";import"./index-CsyBV8c4.js";import"./index-i4fVtm5m.js";import"./index-DwyAMUi7.js";import"./Combination-b0v2E6SL.js";import"./index-CXVzGe8K.js";function Ns(){const b=Te(),{groupId:r}=Re(),{toast:i}=Fe(),{myGroups:de,loadMyGroups:P}=Ge(),{user:x}=Ee(),[h,f]=a.useState([]),[u,v]=a.useState(!1),[p,_]=a.useState(!1),[M,B]=a.useState(!0),[w,z]=a.useState(""),[T,me]=a.useState([]),[xe,U]=a.useState(!1),[$,ue]=a.useState([]),[o,R]=a.useState(null),[F,k]=a.useState(null),[O,pe]=a.useState(!0),[g,N]=a.useState("members"),W=a.useRef(null),K=a.useRef(null),S=a.useRef(null),d=r?de.find(s=>s.group_id===r):null,E=T.find(s=>s.user_id===x?.user_id),V=E?.role==="owner"||E?.role==="admin";a.useEffect(()=>{P().catch(console.error)},[P]),a.useEffect(()=>{r&&d&&(q(),he(),fe())},[r,d]),a.useEffect(()=>{je()},[h]);const q=async()=>{if(!(!r||u)){v(!0);try{const s=await j.getMessages(r,void 0,50);f(s.messages),B(s.has_more)}catch(s){console.error("åŠ è½½æ¶ˆæ¯å¤±è´¥:",s),i({title:"é”™è¯¯",description:"åŠ è½½æ¶ˆæ¯å¤±è´¥",variant:"destructive"})}finally{v(!1)}}},H=async()=>{if(!(!r||u||!M||h.length===0)){v(!0);try{const s=h[0].send_time,t=await j.getMessages(r,s,50);f(n=>[...t.messages,...n]),B(t.has_more)}catch(s){console.error("åŠ è½½æ›´å¤šæ¶ˆæ¯å¤±è´¥:",s)}finally{v(!1)}}},he=async()=>{if(r){U(!0);try{const s=await G.getMembers(r);me(s.members)}catch(s){console.error("åŠ è½½æˆå‘˜å¤±è´¥:",s)}finally{U(!1)}}},fe=async()=>{if(r)try{const s=await G.getNotices(r);ue(s)}catch(s){console.error("åŠ è½½å…¬å‘Šå¤±è´¥:",s)}},ge=()=>{const s=K.current;s&&s.scrollTop===0&&M&&!u&&H()},je=()=>{W.current?.scrollIntoView({behavior:"smooth"})},X=async()=>{if(!r||!w.trim()||p)return;const s=w.trim();z(""),_(!0);try{const t=await j.sendMessage({group_id:r,message_content:s,message_type:"text"}),n={message_uuid:t.message_uuid,group_id:r,sender_id:x?.user_id||"",sender_nickname:x?.nickname||"",sender_avatar_url:"",message_content:s,message_type:"text",file_uuid:null,file_url:null,file_size:null,reply_to:null,send_time:t.send_time,is_recalled:!1};f(c=>[...c,n])}catch(t){console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",t),i({title:"å‘é€å¤±è´¥",description:t instanceof Error?t.message:"å‘é€æ¶ˆæ¯å¤±è´¥",variant:"destructive"}),z(s)}finally{_(!1)}},Ne=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),o?J():X())},ye=s=>{const t=s.target.files?.[0];if(t){if(t.size>100*1024*1024*1024){i({title:"æ–‡ä»¶å¤ªå¤§",description:"æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 100GB",variant:"destructive"});return}R(t)}S.current&&(S.current.value="")},be=()=>{R(null),k(null)},ve=s=>{const t=s.type;return t.startsWith("image/")?{type:"group_image",messageType:"image"}:t.startsWith("video/")?{type:"group_video",messageType:"video"}:{type:"group_document",messageType:"file"}},J=async()=>{if(!r||!o||p)return;const s=o;R(null),_(!0),k(0);try{const{type:t,messageType:n}=ve(s),c=await Ue.uploadFile(s,t,"group_files",r,m=>{k(m.percent)});if(c.isInstant&&c.messageUuid)await q(),i({title:"å‘é€æˆåŠŸ",description:"æ–‡ä»¶ç§’ä¼ æˆåŠŸ"});else{const m=await j.sendMessage({group_id:r,message_content:s.name,message_type:n,file_url:c.fileUrl,file_size:s.size}),se={message_uuid:m.message_uuid,group_id:r,sender_id:x?.user_id||"",sender_nickname:x?.nickname||"",sender_avatar_url:"",message_content:s.name,message_type:n,file_uuid:null,file_url:c.fileUrl,file_size:s.size,reply_to:null,send_time:m.send_time,is_recalled:!1};f(ze=>[...ze,se]),i({title:"å‘é€æˆåŠŸ",description:"æ–‡ä»¶å‘é€æˆåŠŸ"})}}catch(t){console.error("å‘é€æ–‡ä»¶å¤±è´¥:",t),i({title:"å‘é€å¤±è´¥",description:t instanceof Error?t.message:"æ–‡ä»¶å‘é€å¤±è´¥",variant:"destructive"})}finally{_(!1),k(null)}},_e=async s=>{try{await j.deleteMessage(s),f(t=>t.filter(n=>n.message_uuid!==s)),i({title:"æˆåŠŸ",description:"æ¶ˆæ¯å·²åˆ é™¤"})}catch(t){i({title:"åˆ é™¤å¤±è´¥",description:t instanceof Error?t.message:"åˆ é™¤æ¶ˆæ¯å¤±è´¥",variant:"destructive"})}},we=async s=>{try{await j.recallMessage(s),f(t=>t.filter(n=>n.message_uuid!==s)),i({title:"æˆåŠŸ",description:"æ¶ˆæ¯å·²æ’¤å›"})}catch(t){i({title:"æ’¤å›å¤±è´¥",description:t instanceof Error?t.message:"æ’¤å›æ¶ˆæ¯å¤±è´¥",variant:"destructive"})}},ke=(s,t)=>{const n=new Date(s).getTime(),m=Date.now()-n<=120*1e3;return t===x?.user_id&&m||V},Q=async()=>{if(r&&confirm("ç¡®å®šè¦é€€å‡ºè¯¥ç¾¤èŠå—ï¼Ÿ"))try{await G.leaveGroup(r),i({title:"æˆåŠŸ",description:"å·²é€€å‡ºç¾¤èŠ"}),b("/chat")}catch(s){i({title:"é€€å‡ºå¤±è´¥",description:s instanceof Error?s.message:"é€€å‡ºç¾¤èŠå¤±è´¥",variant:"destructive"})}},Se=s=>new Date(s).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),Y=s=>s<1024?s+" B":s<1024*1024?(s/1024).toFixed(1)+" KB":s<1024*1024*1024?(s/1024/1024).toFixed(1)+" MB":(s/1024/1024/1024).toFixed(1)+" GB",Z=s=>{const t=["bg-red-500","bg-orange-500","bg-amber-500","bg-yellow-500","bg-lime-500","bg-green-500","bg-emerald-500","bg-teal-500","bg-cyan-500","bg-sky-500","bg-blue-500","bg-indigo-500","bg-violet-500","bg-purple-500","bg-fuchsia-500","bg-pink-500"],n=s.split("").reduce((c,m)=>c+m.charCodeAt(0),0)%t.length;return t[n]},Ce=s=>s==="owner"?e.jsx($e,{className:"h-4 w-4 text-yellow-500"}):s==="admin"?e.jsx(qe,{className:"h-4 w-4 text-blue-500"}):null,ee=s=>s==="owner"?"ç¾¤ä¸»":s==="admin"?"ç®¡ç†å‘˜":"æˆå‘˜",Me=s=>{if(s.is_recalled)return e.jsx("p",{className:"text-sm italic opacity-60",children:"[æ¶ˆæ¯å·²æ’¤å›]"});switch(s.message_type){case"text":return e.jsx("p",{className:"whitespace-pre-wrap break-words",children:s.message_content});case"image":return s.file_url?e.jsx("img",{src:s.file_url,alt:"å›¾ç‰‡",className:"max-w-xs rounded-lg cursor-pointer hover:opacity-90",onClick:()=>window.open(s.file_url,"_blank")}):e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx("span",{children:"[å›¾ç‰‡]"})]});case"video":return s.file_url?e.jsx("video",{src:s.file_url,controls:!0,className:"max-w-xs rounded-lg"}):e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(oe,{className:"h-4 w-4"}),e.jsx("span",{children:"[è§†é¢‘]"})]});case"file":return e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-background/50 rounded-lg",children:[e.jsx(ce,{className:"h-8 w-8 text-blue-500"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.message_content||"æ–‡ä»¶"}),s.file_size&&e.jsx("p",{className:"text-xs text-muted-foreground",children:Y(s.file_size)})]}),s.file_url&&e.jsx(l,{variant:"ghost",size:"icon",onClick:()=>window.open(s.file_url,"_blank"),children:e.jsx(Xe,{className:"h-4 w-4"})})]});case"system":return e.jsx("p",{className:"text-sm text-center opacity-70",children:s.message_content});default:return e.jsx("p",{className:"text-sm",children:"[ä¸æ”¯æŒçš„æ¶ˆæ¯ç±»å‹]"})}};return r?!d&&!u?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(L,{className:"h-16 w-16 mx-auto text-gray-400 mb-4"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"ç¾¤èŠä¸å­˜åœ¨"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"è¯¥ç¾¤èŠå¯èƒ½å·²è¢«è§£æ•£æˆ–æ‚¨å·²é€€å‡º"}),e.jsx(l,{onClick:()=>b("/chat"),children:"è¿”å›èŠå¤©"})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[e.jsxs("header",{className:"h-16 bg-white border-b flex items-center justify-between px-4 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(l,{variant:"ghost",size:"icon",onClick:()=>b("/chat"),children:e.jsx(Oe,{className:"h-5 w-5"})}),e.jsxs(I,{className:"h-10 w-10",children:[e.jsx(A,{src:d?.group_avatar_url}),e.jsx(D,{className:"bg-gradient-to-br from-blue-500 to-purple-500 text-white",children:d?.group_name?.[0]?.toUpperCase()||"G"})]}),e.jsxs("div",{children:[e.jsx("h1",{className:"font-semibold",children:d?.group_name||"ç¾¤èŠ"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[T.length," æˆå‘˜"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{variant:"ghost",size:"icon",onClick:()=>pe(!O),children:e.jsx(L,{className:"h-5 w-5"})}),e.jsxs(te,{children:[e.jsx(re,{asChild:!0,children:e.jsx(l,{variant:"ghost",size:"icon",children:e.jsx(Le,{className:"h-5 w-5"})})}),e.jsx(ae,{children:e.jsxs(ne,{className:"min-w-[160px] bg-white rounded-lg shadow-xl border p-1 z-50",children:[e.jsxs(y,{className:"flex items-center gap-2 px-3 py-2 text-sm cursor-pointer hover:bg-gray-100 rounded outline-none",onSelect:()=>N("settings"),children:[e.jsx(We,{size:16}),"ç¾¤è®¾ç½®"]}),e.jsxs(y,{className:"flex items-center gap-2 px-3 py-2 text-sm cursor-pointer hover:bg-gray-100 rounded outline-none",onSelect:()=>N("notices"),children:[e.jsx(Ke,{size:16}),"ç¾¤å…¬å‘Š"]}),e.jsx(De,{className:"h-px bg-gray-200 my-1"}),e.jsxs(y,{className:"flex items-center gap-2 px-3 py-2 text-sm cursor-pointer hover:bg-gray-100 rounded outline-none text-red-600",onSelect:Q,children:[e.jsx(ie,{size:16}),"é€€å‡ºç¾¤èŠ"]})]})})]})]})]}),e.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("div",{ref:K,className:"flex-1 overflow-y-auto p-4 space-y-4",onScroll:ge,children:u&&h.length===0?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(C,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):h.length===0?e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:e.jsx("p",{className:"text-sm",children:"æš‚æ— æ¶ˆæ¯ï¼Œå¼€å§‹èŠå¤©å§ï¼"})}):e.jsxs(e.Fragment,{children:[M&&e.jsx("div",{className:"text-center",children:e.jsxs(l,{variant:"ghost",size:"sm",onClick:H,disabled:u,children:[u?e.jsx(C,{className:"h-4 w-4 mr-2 animate-spin"}):null,"åŠ è½½æ›´å¤š"]})}),h.map(s=>{const t=s.sender_id===x?.user_id,n=Z(s.sender_nickname),c=ke(s.send_time,s.sender_id);return s.message_type==="system"?e.jsx("div",{className:"flex justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground bg-gray-200 px-3 py-1 rounded-full",children:s.message_content})},s.message_uuid):e.jsxs("div",{className:`flex gap-3 ${t?"flex-row-reverse":"flex-row"} group`,children:[e.jsxs(I,{className:"h-10 w-10 shrink-0",children:[e.jsx(A,{src:s.sender_avatar_url}),e.jsx(D,{className:n+" text-white",children:s.sender_nickname[0]?.toUpperCase()})]}),e.jsxs("div",{className:`flex flex-col gap-1 max-w-[70%] ${t?"items-end":"items-start"}`,children:[!t&&e.jsx("span",{className:"text-xs text-muted-foreground px-2",children:s.sender_nickname}),e.jsxs(te,{children:[e.jsx(re,{asChild:!0,children:e.jsx("div",{className:`rounded-2xl px-4 py-2 cursor-pointer hover:shadow-md transition-shadow ${t?"bg-primary text-primary-foreground":"bg-white border"}`,children:Me(s)})}),e.jsx(ae,{children:e.jsxs(ne,{className:"min-w-[120px] bg-white rounded-lg shadow-xl border p-1 z-50",sideOffset:5,children:[c&&!s.is_recalled&&e.jsxs(y,{className:"flex items-center gap-2 px-3 py-2 text-sm cursor-pointer hover:bg-gray-100 rounded outline-none",onSelect:()=>we(s.message_uuid),children:[e.jsx(Ve,{size:14}),"æ’¤å›"]}),e.jsxs(y,{className:"flex items-center gap-2 px-3 py-2 text-sm cursor-pointer hover:bg-gray-100 rounded outline-none text-red-600",onSelect:()=>_e(s.message_uuid),children:[e.jsx(Pe,{size:14}),"åˆ é™¤"]})]})})]}),e.jsx("span",{className:"text-xs text-muted-foreground px-2",children:Se(s.send_time)})]})]},s.message_uuid)}),e.jsx("div",{ref:W})]})}),e.jsxs("div",{className:"border-t bg-white p-4 shrink-0",children:[o&&e.jsxs("div",{className:"mb-3 p-3 bg-gray-100 rounded-lg flex items-center gap-3",children:[o.type.startsWith("image/")?e.jsx(le,{className:"h-8 w-8 text-blue-500"}):o.type.startsWith("video/")?e.jsx(oe,{className:"h-8 w-8 text-purple-500"}):e.jsx(ce,{className:"h-8 w-8 text-gray-500"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:o.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:Y(o.size)})]}),e.jsx(l,{variant:"ghost",size:"icon",onClick:be,disabled:p,children:e.jsx(Ie,{className:"h-4 w-4"})})]}),F!==null&&e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground mb-1",children:[e.jsx("span",{children:"ä¸Šä¼ ä¸­..."}),e.jsxs("span",{children:[F.toFixed(1),"%"]})]}),e.jsx("div",{className:"h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary transition-all duration-200",style:{width:`${F}%`}})})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("input",{ref:S,type:"file",className:"hidden",onChange:ye,accept:"image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar"}),e.jsx(l,{variant:"ghost",size:"icon",className:"shrink-0",onClick:()=>S.current?.click(),disabled:p,children:e.jsx(Be,{className:"h-5 w-5"})}),e.jsx(Ae,{placeholder:"è¾“å…¥æ¶ˆæ¯...",value:w,onChange:s=>z(s.target.value),onKeyPress:Ne,className:"flex-1",disabled:p}),e.jsx(l,{onClick:o?J:X,disabled:!w.trim()&&!o||p,className:"shrink-0",children:p?e.jsx(C,{className:"h-5 w-5 animate-spin"}):e.jsx(He,{className:"h-5 w-5"})})]})]})]}),O&&e.jsxs("aside",{className:"w-80 bg-white border-l overflow-y-auto",children:[e.jsxs("div",{className:"flex border-b",children:[e.jsx("button",{className:`flex-1 px-4 py-3 text-sm font-medium border-b-2 ${g==="members"?"border-primary text-primary":"border-transparent"}`,onClick:()=>N("members"),children:"æˆå‘˜"}),e.jsx("button",{className:`flex-1 px-4 py-3 text-sm font-medium border-b-2 ${g==="notices"?"border-primary text-primary":"border-transparent"}`,onClick:()=>N("notices"),children:"å…¬å‘Š"}),e.jsx("button",{className:`flex-1 px-4 py-3 text-sm font-medium border-b-2 ${g==="settings"?"border-primary text-primary":"border-transparent"}`,onClick:()=>N("settings"),children:"è®¾ç½®"})]}),e.jsxs("div",{className:"p-4",children:[g==="members"&&e.jsxs("div",{className:"space-y-2",children:[V&&e.jsxs(l,{variant:"outline",className:"w-full mb-4 gap-2",children:[e.jsx(Je,{className:"h-4 w-4"}),"é‚€è¯·æˆå‘˜"]}),xe?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(C,{className:"h-6 w-6 animate-spin"})}):T.map(s=>e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsxs(I,{className:"h-10 w-10",children:[e.jsx(A,{src:s.user_avatar_url}),e.jsx(D,{className:Z(s.user_nickname)+" text-white",children:s.user_nickname[0]?.toUpperCase()})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium truncate",children:s.group_nickname||s.user_nickname}),Ce(s.role)]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:ee(s.role)})]})]},s.user_id))]}),g==="notices"&&e.jsx("div",{className:"space-y-4",children:$.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"æš‚æ— å…¬å‘Š"}):$.map(s=>e.jsxs("div",{className:`p-4 rounded-lg border ${s.is_pinned?"border-primary bg-primary/5":"bg-gray-50"}`,children:[s.is_pinned&&e.jsx("span",{className:"text-xs text-primary font-medium",children:"ğŸ“Œ ç½®é¡¶"}),e.jsx("h4",{className:"font-medium mt-1",children:s.title}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:s.content}),e.jsxs("div",{className:"flex items-center gap-2 mt-3 text-xs text-muted-foreground",children:[e.jsx("span",{children:s.publisher_nickname}),e.jsx("span",{children:"Â·"}),e.jsx("span",{children:new Date(s.published_at).toLocaleDateString()})]})]},s.id))}),g==="settings"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"ç¾¤ä¿¡æ¯"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"ç¾¤åç§°"}),e.jsx("span",{children:d?.group_name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"ç¾¤ID"}),e.jsxs("span",{className:"text-xs font-mono",children:[d?.group_id?.slice(0,8),"..."]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"æˆ‘çš„è§’è‰²"}),e.jsx("span",{children:ee(E?.role||"member")})]})]})]}),e.jsx("div",{className:"border-t pt-4",children:e.jsxs(l,{variant:"destructive",className:"w-full gap-2",onClick:Q,children:[e.jsx(ie,{className:"h-4 w-4"}),"é€€å‡ºç¾¤èŠ"]})})]})]})]})]})]}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(L,{className:"h-16 w-16 mx-auto text-gray-400 mb-4"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"è¯·é€‰æ‹©ä¸€ä¸ªç¾¤èŠ"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"ä»ä¾§è¾¹æ é€‰æ‹©ä¸€ä¸ªç¾¤èŠå¼€å§‹å¯¹è¯"}),e.jsx(l,{onClick:()=>b("/chat"),children:"è¿”å›èŠå¤©"})]})})}export{Ns as default};

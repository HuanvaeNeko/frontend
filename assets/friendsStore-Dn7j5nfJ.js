import{c as l,n as g,a as u,l as h}from"./index-DW35rIVo.js";const w=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],y=l("user-minus",w),a=`${g()}/api/friends`,d=()=>{const e=u.getState().accessToken;return{"Content-Type":"application/json",...e?{Authorization:`Bearer ${e}`}:{}}},i=async(e,t={})=>{const r=u.getState();if(r.checkTokenExpiry()&&r.refreshToken)try{await r.refreshAccessToken()}catch(n){console.error("Failed to refresh token:",n)}const s=d();let o=await fetch(e,{...t,headers:{...s,...t.headers}});if(o.status===401&&r.refreshToken)try{await r.refreshAccessToken();const n=d();o=await fetch(e,{...t,headers:{...n,...t.headers}})}catch(n){throw console.error("Token refresh failed, redirecting to login"),r.clearAuth(),window.location.href="/login",n}return o},c={getFriendsList:async()=>{console.log("ðŸ“± èŽ·å–å¥½å‹åˆ—è¡¨");const e=await i(`${a}`,{method:"GET"});if(!e.ok){const s=await e.json().catch(()=>({message:`èŽ·å–å¥½å‹åˆ—è¡¨å¤±è´¥ (${e.status})`}));throw console.error("èŽ·å–å¥½å‹åˆ—è¡¨å¤±è´¥:",s),new Error(s.message||s.error||"èŽ·å–å¥½å‹åˆ—è¡¨å¤±è´¥")}const t=await e.json();console.log("ðŸ“± å¥½å‹åˆ—è¡¨å“åº”:",t);const r=t.friends||t||[];return Array.isArray(r)?r:[]},sendFriendRequest:async(e,t)=>{console.log("ðŸ“¤ å‘é€å¥½å‹è¯·æ±‚ç»™:",e);const s=u.getState().user?.user_id;if(!s)throw new Error("ç”¨æˆ·æœªç™»å½•");const o=await i(`${a}/requests`,{method:"POST",body:JSON.stringify({user_id:s,target_user_id:e,reason:t||"ä½ å¥½ï¼Œæˆ‘æƒ³åŠ ä½ ä¸ºå¥½å‹",request_time:new Date().toISOString()})});if(!o.ok){const n=await o.json().catch(()=>({message:`å‘é€å¥½å‹è¯·æ±‚å¤±è´¥ (${o.status})`}));throw console.error("å‘é€å¥½å‹è¯·æ±‚å¤±è´¥:",n),new Error(n.message||n.error||"å‘é€å¥½å‹è¯·æ±‚å¤±è´¥")}console.log("âœ… å¥½å‹è¯·æ±‚å‘é€æˆåŠŸ")},approveFriendRequest:async(e,t)=>{console.log("âœ… åŒæ„å¥½å‹è¯·æ±‚:",e);const s=u.getState().user?.user_id;if(!s)throw new Error("ç”¨æˆ·æœªç™»å½•");const o=await i(`${a}/requests/approve`,{method:"POST",body:JSON.stringify({user_id:s,applicant_user_id:e,approved_time:new Date().toISOString(),approved_reason:t})});if(!o.ok){const n=await o.json().catch(()=>({message:`åŒæ„å¥½å‹è¯·æ±‚å¤±è´¥ (${o.status})`}));throw console.error("åŒæ„å¥½å‹è¯·æ±‚å¤±è´¥:",n),new Error(n.message||n.error||"åŒæ„å¥½å‹è¯·æ±‚å¤±è´¥")}console.log("âœ… å·²åŒæ„å¥½å‹è¯·æ±‚")},rejectFriendRequest:async(e,t)=>{console.log("âŒ æ‹’ç»å¥½å‹è¯·æ±‚:",e);const s=u.getState().user?.user_id;if(!s)throw new Error("ç”¨æˆ·æœªç™»å½•");const o=await i(`${a}/requests/reject`,{method:"POST",body:JSON.stringify({user_id:s,applicant_user_id:e,reject_reason:t})});if(!o.ok){const n=await o.json().catch(()=>({message:`æ‹’ç»å¥½å‹è¯·æ±‚å¤±è´¥ (${o.status})`}));throw console.error("æ‹’ç»å¥½å‹è¯·æ±‚å¤±è´¥:",n),new Error(n.message||n.error||"æ‹’ç»å¥½å‹è¯·æ±‚å¤±è´¥")}console.log("âœ… å·²æ‹’ç»å¥½å‹è¯·æ±‚")},getSentRequests:async()=>{console.log("ðŸ“¤ èŽ·å–å·²å‘é€çš„å¥½å‹è¯·æ±‚");const e=await i(`${a}/requests/sent`,{method:"GET"});if(!e.ok){const s=await e.json().catch(()=>({message:`èŽ·å–å·²å‘é€è¯·æ±‚å¤±è´¥ (${e.status})`}));throw console.error("èŽ·å–å·²å‘é€è¯·æ±‚å¤±è´¥:",s),new Error(s.message||s.error||"èŽ·å–å·²å‘é€è¯·æ±‚å¤±è´¥")}const t=await e.json();console.log("ðŸ“¤ å·²å‘é€è¯·æ±‚å“åº”:",t);const r=t.requests||t||[];return Array.isArray(r)?r:[]},getPendingRequests:async()=>{console.log("ðŸ“¬ èŽ·å–å¾…å¤„ç†çš„å¥½å‹è¯·æ±‚");const e=await i(`${a}/requests/pending`,{method:"GET"});if(!e.ok){const s=await e.json().catch(()=>({message:`èŽ·å–å¾…å¤„ç†è¯·æ±‚å¤±è´¥ (${e.status})`}));throw console.error("èŽ·å–å¾…å¤„ç†è¯·æ±‚å¤±è´¥:",s),new Error(s.message||s.error||"èŽ·å–å¾…å¤„ç†è¯·æ±‚å¤±è´¥")}const t=await e.json();console.log("ðŸ“¬ å¾…å¤„ç†è¯·æ±‚å“åº”:",t);const r=t.requests||t||[];return Array.isArray(r)?r:[]},removeFriend:async(e,t)=>{console.log("ðŸ—‘ï¸ åˆ é™¤å¥½å‹:",e);const s=u.getState().user?.user_id;if(!s)throw new Error("ç”¨æˆ·æœªç™»å½•");const o=await i(`${a}/remove`,{method:"POST",body:JSON.stringify({user_id:s,friend_user_id:e,remove_time:new Date().toISOString(),remove_reason:t})});if(!o.ok){const n=await o.json().catch(()=>({message:`åˆ é™¤å¥½å‹å¤±è´¥ (${o.status})`}));throw console.error("åˆ é™¤å¥½å‹å¤±è´¥:",n),new Error(n.message||n.error||"åˆ é™¤å¥½å‹å¤±è´¥")}console.log("âœ… å·²åˆ é™¤å¥½å‹")}},S=h((e,t)=>({friends:[],pendingRequests:[],sentRequests:[],onlineStatus:new Map,isLoading:!1,error:null,loadFriends:async()=>{e({isLoading:!0,error:null});try{const r=await c.getFriendsList();e({friends:r,isLoading:!1})}catch(r){const s=r instanceof Error?r.message:"åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥";throw e({error:s,isLoading:!1}),r}},loadPendingRequests:async()=>{e({isLoading:!0,error:null});try{const r=await c.getPendingRequests();e({pendingRequests:r,isLoading:!1})}catch(r){const s=r instanceof Error?r.message:"åŠ è½½å¥½å‹è¯·æ±‚å¤±è´¥";throw e({error:s,isLoading:!1}),r}},loadSentRequests:async()=>{e({isLoading:!0,error:null});try{const r=await c.getSentRequests();e({sentRequests:r,isLoading:!1})}catch(r){const s=r instanceof Error?r.message:"åŠ è½½å·²å‘é€è¯·æ±‚å¤±è´¥";throw e({error:s,isLoading:!1}),r}},sendFriendRequest:async(r,s)=>{e({isLoading:!0,error:null});try{await c.sendFriendRequest(r,s),await t().loadSentRequests(),e({isLoading:!1})}catch(o){const n=o instanceof Error?o.message:"å‘é€å¥½å‹è¯·æ±‚å¤±è´¥";throw e({error:n,isLoading:!1}),o}},approveFriendRequest:async(r,s)=>{e({isLoading:!0,error:null});try{await c.approveFriendRequest(r,s),await t().loadFriends(),await t().loadPendingRequests(),e({isLoading:!1})}catch(o){const n=o instanceof Error?o.message:"åŒæ„å¥½å‹è¯·æ±‚å¤±è´¥";throw e({error:n,isLoading:!1}),o}},rejectFriendRequest:async(r,s)=>{e({isLoading:!0,error:null});try{await c.rejectFriendRequest(r,s),await t().loadPendingRequests(),e({isLoading:!1})}catch(o){const n=o instanceof Error?o.message:"æ‹’ç»å¥½å‹è¯·æ±‚å¤±è´¥";throw e({error:n,isLoading:!1}),o}},removeFriend:async(r,s)=>{e({isLoading:!0,error:null});try{await c.removeFriend(r,s),await t().loadFriends(),e({isLoading:!1})}catch(o){const n=o instanceof Error?o.message:"åˆ é™¤å¥½å‹å¤±è´¥";throw e({error:n,isLoading:!1}),o}},setOnlineStatus:(r,s)=>{const o=new Map(t().onlineStatus);o.set(r,s),e({onlineStatus:o})},isOnline:r=>t().onlineStatus.get(r)||!1,clearError:()=>{e({error:null})}}));export{y as U,S as u};

import{c as se,l as $s,a as _e,n as Es,o as Me,r as i,j as e,h as o,m as ge,A as Ve,X as Ae,R as ts,u as Ls,q as _t}from"./index-DW35rIVo.js";import{I as O}from"./input-f5AW0FoI.js";import{A as ne,a as xe,b as ie}from"./avatar-BGq7Gosz.js";import{u as as,U as fs}from"./friendsStore-Dn7j5nfJ.js";import{E as Ps,T as Re,u as Is,g as S,C as ns,a as be,I as gs,F as De,P as bt,s as je,f as js}from"./storage-UW3RZwoa.js";import{C as Ct,E as kt,u as St}from"./profileStore-CiK1q8As.js";import{L as ee}from"./label-C59nEV0B.js";import{R as Gs,T as Hs,P as qs,C as Os,I as is,L as Mt}from"./index-1jbiq5kt.js";import{U as Ke}from"./user-plus-DBDwmKt9.js";import{L as C}from"./loader-circle-BnlNvwYj.js";import{U as Se}from"./users-BN-OU-3M.js";import{C as Xe}from"./check-DCSHekAZ.js";import{S as Js}from"./search-D8pDuwtO.js";import{C as pe,a as Ce,b as ke,c as fe,d as zt}from"./card-CcSMtKMr.js";import{R as vs,T as Ns,P as ys,O as ws,C as _s,a as bs,D as Cs,b as ks,A as Ss,c as Ie,d as Ge,e as He,f as qe,g as Oe}from"./index-Cs5iciTb.js";import{S as rs}from"./settings-CSPE_HBJ.js";import{B as Tt,S as ss,R as Rt}from"./shield-zGZ-pXQF.js";import{C as Be,w as Ms}from"./webrtc-DMq8_CN2.js";import{V as Fe}from"./video-D47MdYhU.js";import{S as Ws,D as Bs}from"./send-B5Dqmo0T.js";import{M as zs}from"./message-circle-Dvq1Ch-S.js";import"./index-MnEzf-Ac.js";import"./index-D2xAthOw.js";import"./index-DN7uoSTJ.js";import"./index-DUzm_Fz5.js";import"./index-CsyBV8c4.js";import"./index-i4fVtm5m.js";import"./index-DwyAMUi7.js";import"./Combination-b0v2E6SL.js";import"./index-CXVzGe8K.js";const At=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],Dt=se("chevron-right",At);const Ft=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]],Ut=se("file-image",Ft);const $t=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M15.033 13.44a.647.647 0 0 1 0 1.12l-4.065 2.352a.645.645 0 0 1-.968-.56v-4.704a.645.645 0 0 1 .967-.56z",key:"1tzo1f"}]],Et=se("file-play",$t);const Lt=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}]],Pt=se("file",Lt);const It=[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]],Vs=se("link",It);const Gt=[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],Ts=se("pen-line",Gt);const Ht=[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],qt=se("phone",Ht);const Ot=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],Ye=se("plus",Ot);const Jt=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],Wt=se("smile",Jt);const Bt=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],Rs=se("upload",Bt);const Vt=[["path",{d:"m16 11 2 2 4-4",key:"9rsbq5"}],["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],Kt=se("user-check",Vt);const Xt=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]],Yt=se("volume-2",Xt);const Zt=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]],As=se("volume-x",Zt),Ue=$s((n,r)=>({activeTab:"friends",setActiveTab:s=>n({activeTab:s}),selectedConversation:null,setSelectedConversation:s=>n({selectedConversation:s}),conversations:[],setConversations:s=>{n({conversations:s}),r().updateUnreadCount()},addConversation:s=>{const x=r().conversations;x.find(g=>g.id===s.id)||(n({conversations:[s,...x]}),r().updateUnreadCount())},updateConversation:(s,x)=>{n({conversations:r().conversations.map(h=>h.id===s?{...h,...x}:h)}),r().updateUnreadCount()},removeConversation:s=>{n({conversations:r().conversations.filter(x=>x.id!==s)}),r().updateUnreadCount()},messages:[],setMessages:s=>n({messages:s}),addMessage:s=>{n({messages:[...r().messages,s]})},prependMessages:s=>{n({messages:[...s,...r().messages]})},messageInput:"",setMessageInput:s=>n({messageInput:s}),totalUnreadCount:0,updateUnreadCount:()=>{const s=r().conversations.reduce((x,h)=>x+h.unreadCount,0);n({totalUnreadCount:s})},wsConnected:!1,setWsConnected:s=>n({wsConnected:s}),typingUsers:new Map,setTypingStatus:s=>{const x=`${s.conversationId}-${s.userId}`,h=new Map(r().typingUsers);s.isTyping?h.set(x,{...s,timestamp:Date.now()}):h.delete(x),n({typingUsers:h}),s.isTyping&&setTimeout(()=>{const g=r().typingUsers.get(x);g&&Date.now()-g.timestamp>=5e3&&r().clearTypingStatus(s.conversationId,s.userId)},5e3)},clearTypingStatus:(s,x)=>{const h=`${s}-${x}`,g=new Map(r().typingUsers);g.delete(h),n({typingUsers:g})},getTypingUsers:s=>{const x=r().typingUsers;return Array.from(x.values()).filter(h=>h.conversationId===s&&h.isTyping)},clearCurrentChat:()=>{n({selectedConversation:null,messages:[],messageInput:""})}})),Ds=10,Qt=1e3,ea=3e4,Fs=$s((n,r)=>{let s=null,x=null;const h=()=>{s&&(clearInterval(s),s=null),x&&(clearTimeout(x),x=null)},g=()=>{const p=r();if(p.reconnecting||p.reconnectAttempts>=Ds){p.reconnectAttempts>=Ds&&n({error:"æ— æ³•è¿žæŽ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•"});return}n({reconnecting:!0});const j=Math.min(Qt*Math.pow(2,p.reconnectAttempts),3e4);console.log(`å°†åœ¨ ${j/1e3} ç§’åŽé‡è¿ž (ç¬¬ ${p.reconnectAttempts+1} æ¬¡å°è¯•)`),x=setTimeout(()=>{n(N=>({reconnectAttempts:N.reconnectAttempts+1})),r().connect()},j)};return{ws:null,connected:!1,reconnecting:!1,reconnectAttempts:0,error:null,lastPingTime:null,messageHandlers:new Map,connect:()=>{const p=r(),j=_e.getState();if(!j.accessToken){console.warn("æœªç™»å½•ï¼Œæ— æ³•è¿žæŽ¥ WebSocket");return}p.ws&&p.ws.close(),h();try{const I=`${Es().replace(/^http/,"ws")}/ws/messages?token=${j.accessToken}`;console.log("ðŸ”Œ è¿žæŽ¥ WebSocket...");const w=new WebSocket(I);w.onopen=()=>{console.log("âœ… WebSocket å·²è¿žæŽ¥"),n({connected:!0,reconnecting:!1,reconnectAttempts:0,error:null}),s=setInterval(()=>{w.readyState===WebSocket.OPEN&&(w.send(JSON.stringify({type:"ping"})),n({lastPingTime:Date.now()}))},ea)},w.onmessage=_=>{try{const y=JSON.parse(_.data);if(y.type==="pong")return;console.log("ðŸ“¨ æ”¶åˆ°æ¶ˆæ¯:",y.type);const D=r().messageHandlers.get(y.type);D&&D.forEach(F=>{try{F(y.data)}catch(M){console.error(`æ¶ˆæ¯å¤„ç†å™¨é”™è¯¯ (${y.type}):`,M)}});const E=r().messageHandlers.get("*");E&&E.forEach(F=>{try{F(y)}catch(M){console.error("é€šé…ç¬¦æ¶ˆæ¯å¤„ç†å™¨é”™è¯¯:",M)}})}catch(y){console.error("è§£æžæ¶ˆæ¯å¤±è´¥:",y)}},w.onerror=_=>{console.error("âŒ WebSocket é”™è¯¯:",_),n({error:"WebSocket è¿žæŽ¥é”™è¯¯",connected:!1})},w.onclose=_=>{console.log("ðŸ”Œ WebSocket å·²æ–­å¼€:",_.code,_.reason),n({connected:!1,ws:null}),h(),_.code!==1e3&&_.code!==1001&&g()},n({ws:w,error:null,reconnecting:!1})}catch(N){console.error("åˆ›å»º WebSocket è¿žæŽ¥å¤±è´¥:",N),n({error:N instanceof Error?N.message:"WebSocket è¿žæŽ¥å¤±è´¥",connected:!1}),g()}},disconnect:()=>{const p=r();h(),p.ws&&(p.ws.close(1e3,"User disconnect"),n({ws:null,connected:!1,reconnecting:!1,reconnectAttempts:0}))},send:p=>{const j=r();j.ws&&j.connected?j.ws.send(JSON.stringify(p)):console.error("WebSocket æœªè¿žæŽ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯")},sendTyping:(p,j,N)=>{r().send({type:"typing",data:{conversation_type:p,conversation_id:j,is_typing:N}})},registerHandler:(p,j)=>{const N=r().messageHandlers;return N.has(p)||N.set(p,new Set),N.get(p).add(j),n({messageHandlers:new Map(N)}),()=>{r().unregisterHandler(p,j)}},unregisterHandler:(p,j)=>{const N=r().messageHandlers,$=N.get(p);$&&($.delete(j),$.size===0&&N.delete(p),n({messageHandlers:new Map(N)}))}}}),sa={hidden:{opacity:0,x:-20},visible:n=>({opacity:1,x:0,transition:{delay:n*.05,duration:.3,ease:[.25,.1,.25,1]}}),exit:{opacity:0,x:20,transition:{duration:.2}}},ta={hidden:{opacity:0,scale:.95,y:10},visible:{opacity:1,scale:1,y:0,transition:{type:"spring",stiffness:300,damping:25}},exit:{opacity:0,scale:.95,y:10,transition:{duration:.2}}},aa={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.5,ease:"easeOut"}}};function na({subTab:n,searchQuery:r}){const{toast:s}=Me(),{friends:x,pendingRequests:h,sentRequests:g,isLoading:p,sendFriendRequest:j,approveFriendRequest:N,rejectFriendRequest:$,removeFriend:I,isOnline:w}=as(),{setSelectedConversation:_,selectedConversation:y}=Ue(),[D,E]=i.useState(!1),[F,M]=i.useState(""),[T,R]=i.useState(""),[L,B]=i.useState(!1),[J,G]=i.useState(null),V=Array.isArray(x)?x:[],l=Array.isArray(h)?h:[],f=Array.isArray(g)?g:[],b=V.filter(d=>d.nickname.toLowerCase().includes(r.toLowerCase())||d.user_id.toLowerCase().includes(r.toLowerCase())),k=async()=>{if(!F.trim()){s({title:"é”™è¯¯",description:"è¯·è¾“å…¥ç”¨æˆ·ID",variant:"destructive"});return}B(!0);try{await j(F.trim(),T.trim()||void 0),s({title:"æˆåŠŸ",description:"å¥½å‹è¯·æ±‚å·²å‘é€"}),E(!1),M(""),R("")}catch(d){s({title:"å¤±è´¥",description:d instanceof Error?d.message:"å‘é€è¯·æ±‚å¤±è´¥",variant:"destructive"})}finally{B(!1)}},W=async d=>{try{await N(d),s({title:"æˆåŠŸ",description:"å·²æ·»åŠ å¥½å‹"})}catch(H){s({title:"å¤±è´¥",description:H instanceof Error?H.message:"æ“ä½œå¤±è´¥",variant:"destructive"})}},v=async d=>{try{await $(d),s({title:"å·²æ‹’ç»",description:"å·²æ‹’ç»è¯¥å¥½å‹è¯·æ±‚"})}catch(H){s({title:"å¤±è´¥",description:H instanceof Error?H.message:"æ“ä½œå¤±è´¥",variant:"destructive"})}},P=async(d,H)=>{if(confirm(`ç¡®å®šè¦åˆ é™¤å¥½å‹ ${H} å—ï¼Ÿåˆ é™¤åŽå°†æ— æ³•äº’ç›¸å‘é€æ¶ˆæ¯ã€‚`)){G(d);try{await I(d),s({title:"å·²åˆ é™¤",description:`${H} å·²ä»Žå¥½å‹åˆ—è¡¨ç§»é™¤`}),y?.id===d&&_(null)}catch(Z){s({title:"åˆ é™¤å¤±è´¥",description:Z instanceof Error?Z.message:"æ“ä½œå¤±è´¥",variant:"destructive"})}finally{G(null)}}},Y=d=>{_({id:d.user_id,type:"friend",name:d.nickname,avatar:d.avatar_url,unreadCount:0,online:!1})};return n==="main"?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsxs(o,{className:"w-full gap-2",onClick:()=>E(!0),children:[e.jsx(Ke,{className:"h-4 w-4"}),"æ·»åŠ å¥½å‹"]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:p?e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsx(C,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):b.length===0?e.jsxs(ge.div,{className:"flex flex-col items-center justify-center h-32 text-muted-foreground",variants:aa,initial:"hidden",animate:"visible",children:[e.jsx(Se,{className:"h-12 w-12 mb-2 opacity-30"}),e.jsx("p",{className:"text-sm",children:"æš‚æ— å¥½å‹"}),r&&e.jsx("p",{className:"text-xs mt-1",children:"è¯•è¯•å…¶ä»–æœç´¢æ¡ä»¶"})]}):e.jsx(Ve,{mode:"popLayout",children:b.map((d,H)=>e.jsxs(ge.div,{className:`w-full p-4 flex items-center gap-3 hover:bg-accent transition-colors ${y?.id===d.user_id?"bg-accent":""}`,variants:sa,initial:"hidden",animate:"visible",exit:"exit",custom:H,whileHover:{backgroundColor:"rgba(0,0,0,0.04)"},layout:!0,children:[e.jsxs("button",{className:"flex items-center gap-3 flex-1 min-w-0",onClick:()=>Y(d),children:[e.jsxs("div",{className:"relative",children:[e.jsxs(ne,{className:"h-12 w-12",children:[e.jsx(xe,{src:d.avatar_url}),e.jsx(ie,{children:d.nickname[0]?.toUpperCase()})]}),e.jsx("span",{className:`absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white ${w(d.user_id)?"bg-green-500":"bg-gray-400"}`,title:w(d.user_id)?"åœ¨çº¿":"ç¦»çº¿"})]}),e.jsxs("div",{className:"flex-1 text-left min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium truncate",children:d.nickname}),w(d.user_id)&&e.jsx("span",{className:"text-xs text-green-600",children:"åœ¨çº¿"})]}),e.jsx("div",{className:"text-sm text-muted-foreground truncate",children:d.signature||d.user_id})]})]}),e.jsxs(Gs,{children:[e.jsx(Hs,{asChild:!0,children:e.jsx(o,{variant:"ghost",size:"icon",className:"h-8 w-8 shrink-0",children:e.jsx(Ps,{className:"h-4 w-4"})})}),e.jsx(qs,{children:e.jsx(Os,{className:"min-w-32 bg-white rounded-md shadow-lg border p-1 z-50",align:"end",children:e.jsxs(is,{className:"flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded cursor-pointer outline-none",onClick:()=>P(d.user_id,d.nickname),disabled:J===d.user_id,children:[J===d.user_id?e.jsx(C,{className:"h-4 w-4 animate-spin"}):e.jsx(Re,{className:"h-4 w-4"}),"åˆ é™¤å¥½å‹"]})})})]})]},d.user_id))})}),e.jsx(Ve,{children:D&&e.jsx(ge.div,{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsxs(ge.div,{className:"bg-card rounded-lg p-6 w-96 max-w-[90vw] shadow-2xl",variants:ta,initial:"hidden",animate:"visible",exit:"exit",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"æ·»åŠ å¥½å‹"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"userId",children:"ç”¨æˆ·ID"}),e.jsx(O,{id:"userId",placeholder:"è¾“å…¥ç”¨æˆ·ID",value:F,onChange:d=>M(d.target.value)})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"reason",children:"éªŒè¯æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰"}),e.jsx(O,{id:"reason",placeholder:"æˆ‘æ˜¯...",value:T,onChange:d=>R(d.target.value)})]})]}),e.jsxs("div",{className:"flex gap-2 mt-6",children:[e.jsx(o,{variant:"outline",className:"flex-1",onClick:()=>{E(!1),M(""),R("")},disabled:L,children:"å–æ¶ˆ"}),e.jsx(o,{className:"flex-1",onClick:k,disabled:L,children:L?e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"h-4 w-4 mr-2 animate-spin"}),"å‘é€ä¸­..."]}):"å‘é€è¯·æ±‚"})]})]})})})]}):n==="new"?e.jsx("div",{className:"flex-1 overflow-y-auto",children:p?e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsx(C,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):l.length===0?e.jsx("div",{className:"flex flex-col items-center justify-center h-32 text-muted-foreground",children:e.jsx("p",{className:"text-sm",children:"æš‚æ— æ–°çš„å¥½å‹è¯·æ±‚"})}):l.map(d=>e.jsx("div",{className:"p-4 border-b hover:bg-accent transition-colors",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ne,{className:"h-12 w-12",children:e.jsx(ie,{children:d.nickname[0]?.toUpperCase()})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium",children:d.nickname}),e.jsx("div",{className:"text-xs text-muted-foreground",children:d.applicant_user_id}),d.reason&&e.jsx("div",{className:"text-sm text-muted-foreground mt-1",children:d.reason}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:new Date(d.request_time).toLocaleString()}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsxs(o,{size:"sm",variant:"default",className:"gap-1",onClick:()=>W(d.applicant_user_id),children:[e.jsx(Xe,{className:"h-3 w-3"}),"åŒæ„"]}),e.jsxs(o,{size:"sm",variant:"outline",className:"gap-1",onClick:()=>v(d.applicant_user_id),children:[e.jsx(Ae,{className:"h-3 w-3"}),"æ‹’ç»"]})]})]})]})},d.applicant_user_id))}):n==="sent"?e.jsx("div",{className:"flex-1 overflow-y-auto",children:p?e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsx(C,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):f.length===0?e.jsx("div",{className:"flex flex-col items-center justify-center h-32 text-muted-foreground",children:e.jsx("p",{className:"text-sm",children:"æš‚æ— å·²å‘é€çš„è¯·æ±‚"})}):f.map(d=>e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ne,{className:"h-12 w-12",children:e.jsx(ie,{children:d.target_user_id[0]?.toUpperCase()})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium",children:d.target_user_id}),d.reason&&e.jsx("div",{className:"text-sm text-muted-foreground mt-1",children:d.reason}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${d.status==="approved"?"bg-green-100 text-green-700":d.status==="rejected"?"bg-red-100 text-red-700":"bg-yellow-100 text-yellow-700"}`,children:d.status==="approved"?"å·²åŒæ„":d.status==="rejected"?"å·²æ‹’ç»":"å¾…å¤„ç†"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(d.request_time).toLocaleString()})]})]})]})},d.target_user_id))}):null}function ia({subTab:n,searchQuery:r}){const{toast:s}=Me(),{myGroups:x,isLoading:h,createGroup:g,loadMyGroups:p,selectGroup:j}=Is(),{setSelectedConversation:N,selectedConversation:$}=Ue(),[I,w]=i.useState(!1),[_,y]=i.useState(""),[D,E]=i.useState(""),[F,M]=i.useState("open"),[T,R]=i.useState(!1),[L,B]=i.useState(""),[J,G]=i.useState(!1),[V,l]=i.useState(""),[f,b]=i.useState(!1),[k,W]=i.useState(null),[v,P]=i.useState(""),[Y,d]=i.useState(!1),[H,Z]=i.useState([]),[re,he]=i.useState(!1),[de,le]=i.useState(null),ve=(Array.isArray(x)?x:[]).filter(c=>c.group_name.toLowerCase().includes(r.toLowerCase())||c.group_id.toLowerCase().includes(r.toLowerCase()));i.useEffect(()=>{n==="invites"&&te()},[n]);const te=async()=>{he(!0);try{const c=await S.getInvitations();Z(Array.isArray(c)?c:[])}catch(c){console.error("åŠ è½½ç¾¤é‚€è¯·å¤±è´¥:",c)}finally{he(!1)}},a=async()=>{if(!_.trim()){s({title:"é”™è¯¯",description:"è¯·è¾“å…¥ç¾¤åç§°",variant:"destructive"});return}R(!0);try{await g(_.trim(),D.trim()||void 0,F),s({title:"æˆåŠŸ",description:"ç¾¤èŠåˆ›å»ºæˆåŠŸ"}),w(!1),y(""),E(""),M("open")}catch(c){s({title:"å¤±è´¥",description:c instanceof Error?c.message:"åˆ›å»ºç¾¤èŠå¤±è´¥",variant:"destructive"})}finally{R(!1)}},m=c=>{j(c),N({id:c.group_id,type:"group",name:c.group_name,avatar:c.group_avatar_url,unreadCount:c.unread_count||0,lastMessage:c.last_message_content||void 0,lastTime:c.last_message_time||void 0})},z=async()=>{if(!L.trim()){s({title:"é”™è¯¯",description:"è¯·è¾“å…¥é‚€è¯·ç ",variant:"destructive"});return}G(!0);try{await S.joinByCode(L.trim()),s({title:"æˆåŠŸ",description:"åŠ å…¥ç¾¤èŠæˆåŠŸ"}),B(""),p()}catch(c){s({title:"å¤±è´¥",description:c instanceof Error?c.message:"åŠ å…¥ç¾¤èŠå¤±è´¥",variant:"destructive"})}finally{G(!1)}},me=async()=>{if(!V.trim()){s({title:"é”™è¯¯",description:"è¯·è¾“å…¥ç¾¤ID",variant:"destructive"});return}b(!0),W(null);try{const c=await S.searchGroups(V.trim());c.length>0?W(c[0]):s({title:"æœªæ‰¾åˆ°",description:"æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç¾¤èŠ",variant:"destructive"})}catch(c){s({title:"å¤±è´¥",description:c instanceof Error?c.message:"æœç´¢ç¾¤èŠå¤±è´¥",variant:"destructive"})}finally{b(!1)}},ce=async()=>{if(k){d(!0);try{await S.applyToJoin(k.group_id,v),s({title:"æˆåŠŸ",description:(k.join_mode||"approval_required")==="open"?"åŠ å…¥æˆåŠŸ":"ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…å®¡æ ¸"}),W(null),l(""),P(""),(k.join_mode||"approval_required")==="open"&&p()}catch(c){s({title:"å¤±è´¥",description:c instanceof Error?c.message:"ç”³è¯·å¤±è´¥",variant:"destructive"})}finally{d(!1)}}},K=async c=>{le(c);try{await S.acceptInvitation(c),s({title:"æˆåŠŸ",description:"å·²åŠ å…¥ç¾¤èŠ"}),Z(X=>X.filter(u=>u.request_id!==c)),p()}catch(X){s({title:"å¤±è´¥",description:X instanceof Error?X.message:"æŽ¥å—é‚€è¯·å¤±è´¥",variant:"destructive"})}finally{le(null)}},Q=async c=>{le(c);try{await S.declineInvitation(c),s({title:"å·²æ‹’ç»",description:"å·²æ‹’ç»ç¾¤é‚€è¯·"}),Z(X=>X.filter(u=>u.request_id!==c))}catch(X){s({title:"å¤±è´¥",description:X instanceof Error?X.message:"æ‹’ç»é‚€è¯·å¤±è´¥",variant:"destructive"})}finally{le(null)}},ue=c=>({open:"å¼€æ”¾åŠ å…¥",approval_required:"éœ€è¦å®¡æ ¸",invite_only:"ä»…é‚€è¯·",admin_invite_only:"ä»…ç®¡ç†å‘˜é‚€è¯·",closed:"ç¦æ­¢åŠ å…¥"})[c]||c;return n==="main"?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b flex gap-2",children:[e.jsxs(o,{className:"flex-1 gap-2",onClick:()=>w(!0),children:[e.jsx(Ye,{className:"h-4 w-4"}),"åˆ›å»ºç¾¤èŠ"]}),e.jsx(o,{variant:"outline",size:"icon",onClick:()=>p(),disabled:h,children:e.jsx(ts,{className:`h-4 w-4 ${h?"animate-spin":""}`})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:h?e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsx(C,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):ve.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-32 text-muted-foreground",children:[e.jsx(Se,{className:"h-8 w-8 mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"æš‚æ— ç¾¤èŠ"}),r&&e.jsx("p",{className:"text-xs mt-1",children:"è¯•è¯•å…¶ä»–æœç´¢æ¡ä»¶"})]}):ve.map(c=>e.jsxs("button",{className:`w-full p-4 flex items-center gap-3 hover:bg-accent transition-colors ${$?.id===c.group_id?"bg-accent":""}`,onClick:()=>m(c),children:[e.jsxs(ne,{className:"h-12 w-12",children:[e.jsx(xe,{src:c.group_avatar_url}),e.jsx(ie,{className:"bg-gradient-to-br from-blue-500 to-purple-500 text-white",children:c.group_name[0]?.toUpperCase()})]}),e.jsxs("div",{className:"flex-1 text-left min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium truncate",children:c.group_name}),c.role==="owner"&&e.jsx(ns,{className:"h-3 w-3 text-yellow-500"}),(c.unread_count??0)>0&&e.jsx("span",{className:"bg-red-500 text-white text-xs rounded-full px-2 py-0.5",children:c.unread_count})]}),e.jsx("div",{className:"text-sm text-muted-foreground truncate",children:c.last_message_content||c.group_description||`${c.member_count||0} åæˆå‘˜`}),c.last_message_time&&e.jsx("div",{className:"text-xs text-muted-foreground mt-0.5",children:new Date(c.last_message_time).toLocaleString()})]}),e.jsx(Dt,{className:"h-4 w-4 text-muted-foreground"})]},c.group_id))}),I&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-card rounded-lg p-6 w-96 max-w-[90vw] shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"åˆ›å»ºç¾¤èŠ"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"groupName",children:"ç¾¤åç§° *"}),e.jsx(O,{id:"groupName",placeholder:"è¾“å…¥ç¾¤åç§°",value:_,onChange:c=>y(c.target.value),maxLength:30})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"groupDescription",children:"ç¾¤æè¿°ï¼ˆå¯é€‰ï¼‰"}),e.jsx(O,{id:"groupDescription",placeholder:"ç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªç¾¤...",value:D,onChange:c=>E(c.target.value),maxLength:200})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"joinMode",children:"åŠ ç¾¤æ–¹å¼"}),e.jsxs("select",{id:"joinMode",className:"w-full px-3 py-2 border rounded-md bg-background",value:F,onChange:c=>M(c.target.value),children:[e.jsx("option",{value:"open",children:"å¼€æ”¾åŠ å…¥ - ä»»ä½•äººå¯ç›´æŽ¥åŠ å…¥"}),e.jsx("option",{value:"approval_required",children:"éœ€è¦å®¡æ‰¹ - éœ€ç®¡ç†å‘˜åŒæ„"}),e.jsx("option",{value:"invite_only",children:"ä»…é‚€è¯· - åªèƒ½é€šè¿‡é‚€è¯·åŠ å…¥"})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-6",children:[e.jsx(o,{variant:"outline",className:"flex-1",onClick:()=>{w(!1),y(""),E(""),M("open")},disabled:T,children:"å–æ¶ˆ"}),e.jsx(o,{className:"flex-1",onClick:a,disabled:T||!_.trim(),children:T?e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"h-4 w-4 mr-2 animate-spin"}),"åˆ›å»ºä¸­..."]}):"åˆ›å»º"})]})]})})]}):n==="join"?e.jsxs("div",{className:"flex flex-col h-full p-4 space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(Vs,{className:"h-4 w-4"}),"é€šè¿‡é‚€è¯·ç åŠ å…¥"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(O,{placeholder:"è¾“å…¥é‚€è¯·ç ",value:L,onChange:c=>B(c.target.value.toUpperCase()),className:"font-mono",maxLength:10}),e.jsx(o,{onClick:z,disabled:J||!L.trim(),children:J?e.jsx(C,{className:"h-4 w-4 animate-spin"}):"åŠ å…¥"})]})]}),e.jsx("div",{className:"border-t"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(Js,{className:"h-4 w-4"}),"æœç´¢ç¾¤èŠ"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(O,{placeholder:"è¾“å…¥ç¾¤ID",value:V,onChange:c=>l(c.target.value)}),e.jsx(o,{variant:"outline",onClick:me,disabled:f||!V.trim(),children:f?e.jsx(C,{className:"h-4 w-4 animate-spin"}):"æœç´¢"})]}),k&&e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ne,{className:"h-12 w-12",children:[e.jsx(xe,{src:k.group_avatar_url}),e.jsx(ie,{className:"bg-gradient-to-br from-blue-500 to-purple-500 text-white",children:k.group_name[0]?.toUpperCase()})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:k.group_name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[k.member_count??0," æˆå‘˜ Â· ",ue(k.join_mode||"approval_required")]})]})]}),(k.join_mode||"approval_required")!=="open"&&e.jsxs("div",{children:[e.jsx(ee,{children:"ç”³è¯·ç†ç”±"}),e.jsx(O,{placeholder:"è¯´æ˜ŽåŠ ç¾¤åŽŸå› ï¼ˆå¯é€‰ï¼‰",value:v,onChange:c=>P(c.target.value),className:"mt-1",maxLength:100})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{variant:"outline",className:"flex-1",onClick:()=>{W(null),l(""),P("")},children:"å–æ¶ˆ"}),e.jsx(o,{className:"flex-1",onClick:ce,disabled:Y,children:Y?e.jsx(C,{className:"h-4 w-4 animate-spin"}):(k.join_mode||"approval_required")==="open"?"åŠ å…¥":"ç”³è¯·åŠ å…¥"})]})]})]})]}):n==="invites"?e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"p-4 border-b flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"ç¾¤é‚€è¯·"}),e.jsx(o,{variant:"ghost",size:"icon",onClick:te,disabled:re,children:e.jsx(ts,{className:`h-4 w-4 ${re?"animate-spin":""}`})})]}),re?e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsx(C,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):H.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-32 text-muted-foreground",children:[e.jsx(Se,{className:"h-8 w-8 mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"æš‚æ— ç¾¤é‚€è¯·"})]}):H.map(c=>e.jsxs("div",{className:"p-4 border-b flex items-center gap-3",children:[e.jsxs(ne,{className:"h-12 w-12",children:[e.jsx(xe,{src:c.group_avatar_url}),e.jsx(ie,{className:"bg-gradient-to-br from-blue-500 to-purple-500 text-white",children:c.group_name[0]?.toUpperCase()})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:c.group_name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[c.inviter_nickname," é‚€è¯·ä½ åŠ å…¥"]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:new Date(c.created_at).toLocaleDateString()})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{size:"sm",onClick:()=>K(c.request_id),disabled:de===c.request_id,children:de===c.request_id?e.jsx(C,{className:"h-4 w-4 animate-spin"}):e.jsx(Xe,{className:"h-4 w-4"})}),e.jsx(o,{variant:"outline",size:"sm",onClick:()=>Q(c.request_id),disabled:de===c.request_id,children:e.jsx(Ae,{className:"h-4 w-4"})})]})]},c.request_id))]}):null}const Je=`${Es()}/api/messages`,Us=()=>{const n=_e.getState().accessToken;return{"Content-Type":"application/json",...n?{Authorization:`Bearer ${n}`}:{}}},We=async(n,r={})=>{const s=_e.getState();if(s.checkTokenExpiry()&&s.refreshToken)try{await s.refreshAccessToken()}catch(g){console.error("Failed to refresh token:",g)}const x=Us();let h=await fetch(n,{...r,headers:{...x,...r.headers}});if(h.status===401&&s.refreshToken)try{await s.refreshAccessToken();const g=Us();h=await fetch(n,{...r,headers:{...g,...r.headers}})}catch(g){throw console.error("Token refresh failed, redirecting to login"),s.clearAuth(),window.location.href="/login",g}return h},ye={sendMessage:async n=>{console.log("ðŸ“¤ å‘é€æ¶ˆæ¯ç»™:",n.receiver_id);const r=await We(`${Je}`,{method:"POST",body:JSON.stringify(n)});if(!r.ok){const x=await r.json().catch(()=>({message:`å‘é€æ¶ˆæ¯å¤±è´¥ (${r.status})`}));throw console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",x),new Error(x.message||x.error||"å‘é€æ¶ˆæ¯å¤±è´¥")}const s=await r.json();return console.log("âœ… æ¶ˆæ¯å‘é€æˆåŠŸ:",s.message_uuid),s},getMessages:async(n,r,s=50)=>{console.log("ðŸ“¥ èŽ·å–æ¶ˆæ¯åˆ—è¡¨:",n);const x=new URLSearchParams({friend_id:n,limit:s.toString()});r&&x.set("before_time",r);const h=await We(`${Je}?${x}`,{method:"GET"});if(!h.ok){const p=await h.json().catch(()=>({message:`èŽ·å–æ¶ˆæ¯å¤±è´¥ (${h.status})`}));throw console.error("èŽ·å–æ¶ˆæ¯å¤±è´¥:",p),new Error(p.message||p.error||"èŽ·å–æ¶ˆæ¯å¤±è´¥")}return await h.json()},deleteMessage:async n=>{console.log("ðŸ—‘ï¸ åˆ é™¤æ¶ˆæ¯:",n);const r=await We(`${Je}/delete`,{method:"DELETE",body:JSON.stringify({message_uuid:n})});if(!r.ok){const x=await r.json().catch(()=>({message:`åˆ é™¤æ¶ˆæ¯å¤±è´¥ (${r.status})`}));throw console.error("åˆ é™¤æ¶ˆæ¯å¤±è´¥:",x),new Error(x.message||x.error||"åˆ é™¤æ¶ˆæ¯å¤±è´¥")}const s=await r.json();return console.log("âœ… æ¶ˆæ¯åˆ é™¤æˆåŠŸ"),s},recallMessage:async n=>{console.log("â†©ï¸ æ’¤å›žæ¶ˆæ¯:",n);const r=await We(`${Je}/recall`,{method:"POST",body:JSON.stringify({message_uuid:n})});if(!r.ok){const x=await r.json().catch(()=>({message:`æ’¤å›žæ¶ˆæ¯å¤±è´¥ (${r.status})`}));throw console.error("æ’¤å›žæ¶ˆæ¯å¤±è´¥:",x),new Error(x.message||x.error||"æ’¤å›žæ¶ˆæ¯å¤±è´¥")}const s=await r.json();return console.log("âœ… æ¶ˆæ¯æ’¤å›žæˆåŠŸ"),s},loadMoreMessages:async(n,r,s=50)=>{if(r.length===0)return ye.getMessages(n,void 0,s);const x=r[r.length-1].send_time;return ye.getMessages(n,x,s)}};function ra({groupId:n,onClose:r}){const{toast:s}=Me(),{user:x}=_e(),h=i.useRef(null),[g,p]=i.useState(null),[j,N]=i.useState(!0),[$,I]=i.useState([]),[w,_]=i.useState(!1),[y,D]=i.useState([]),[E,F]=i.useState(!1),[M,T]=i.useState([]),[R,L]=i.useState(!1),[B,J]=i.useState([]),[G,V]=i.useState(!1),[l,f]=i.useState(null),[b,k]=i.useState("info"),[W,v]=i.useState(!1),[P,Y]=i.useState(""),[d,H]=i.useState(!1),[Z,re]=i.useState(""),[he,de]=i.useState(!1),[le,we]=i.useState(null),[ve,te]=i.useState(!1),[a,m]=i.useState(""),[z,me]=i.useState(!1),[ce,K]=i.useState(!1),[Q,ue]=i.useState(""),[c,X]=i.useState(""),[u,q]=i.useState(!1),[ze,ls]=i.useState(!1),[Ks,$e]=i.useState(!1),[cs,Xs]=i.useState(10),[os,Ys]=i.useState(24),[ds,ms]=i.useState(!1),[Ze,Zs]=i.useState(null),[Qs,Ee]=i.useState(!1),[Qe,us]=i.useState(60),[Ne,ae]=i.useState(!1),es=$.find(t=>t.user_id===x?.user_id),Le=es?.role==="owner",oe=es?.role==="owner"||es?.role==="admin";i.useEffect(()=>{et(),Te(),xs(),oe&&(st(),hs())},[n]);const et=async()=>{N(!0);try{const t=await S.getGroupDetail(n);p(t),Y(t.group_name),re(t.group_description||"")}catch{s({title:"é”™è¯¯",description:"åŠ è½½ç¾¤ä¿¡æ¯å¤±è´¥",variant:"destructive"})}finally{N(!1)}},Te=async()=>{_(!0);try{const{members:t}=await S.getMembers(n);I(t)}catch(t){console.error("åŠ è½½æˆå‘˜å¤±è´¥:",t)}finally{_(!1)}},xs=async()=>{F(!0);try{const t=await S.getNotices(n);D(t)}catch(t){console.error("åŠ è½½å…¬å‘Šå¤±è´¥:",t)}finally{F(!1)}},st=async()=>{L(!0);try{const t=await S.getInviteCodes(n);T(t)}catch(t){console.error("åŠ è½½é‚€è¯·ç å¤±è´¥:",t)}finally{L(!1)}},hs=async()=>{V(!0);try{const t=await S.getJoinRequests(n);J(t)}catch(t){console.error("åŠ è½½åŠ å…¥è¯·æ±‚å¤±è´¥:",t)}finally{V(!1)}},tt=async t=>{f(t);try{await S.approveJoinRequest(n,t),s({title:"æˆåŠŸ",description:"å·²é€šè¿‡åŠ å…¥ç”³è¯·"}),J(A=>A.filter(U=>U.request_id!==t)),Te()}catch{s({title:"é”™è¯¯",description:"æ“ä½œå¤±è´¥",variant:"destructive"})}finally{f(null)}},at=async t=>{f(t);try{await S.rejectJoinRequest(n,t),s({title:"å·²æ‹’ç»",description:"å·²æ‹’ç»åŠ å…¥ç”³è¯·"}),J(A=>A.filter(U=>U.request_id!==t))}catch{s({title:"é”™è¯¯",description:"æ“ä½œå¤±è´¥",variant:"destructive"})}finally{f(null)}},nt=async()=>{if(P.trim())try{await S.updateGroup(n,{group_name:P.trim()}),p(t=>t?{...t,group_name:P.trim()}:null),v(!1),s({title:"æˆåŠŸ",description:"ç¾¤åç§°å·²æ›´æ–°"})}catch{s({title:"é”™è¯¯",description:"æ›´æ–°ç¾¤åç§°å¤±è´¥",variant:"destructive"})}},it=async()=>{try{await S.updateGroup(n,{group_description:Z}),p(t=>t?{...t,group_description:Z}:null),H(!1),s({title:"æˆåŠŸ",description:"ç¾¤ç®€ä»‹å·²æ›´æ–°"})}catch{s({title:"é”™è¯¯",description:"æ›´æ–°ç¾¤ç®€ä»‹å¤±è´¥",variant:"destructive"})}},rt=async t=>{const A=t.target.files?.[0];if(A){de(!0);try{const U=await S.uploadGroupAvatar(n,A);p(Pe=>Pe?{...Pe,group_avatar_url:U.avatar_url}:null),s({title:"æˆåŠŸ",description:"ç¾¤å¤´åƒå·²æ›´æ–°"})}catch(U){s({title:"é”™è¯¯",description:U instanceof Error?U.message:"ä¸Šä¼ å¤±è´¥",variant:"destructive"})}finally{de(!1)}}},lt=async t=>{try{await S.updateJoinMode(n,t),p(A=>A?{...A,join_mode:t}:null),s({title:"æˆåŠŸ",description:"å…¥ç¾¤æ¨¡å¼å·²æ›´æ–°"})}catch{s({title:"é”™è¯¯",description:"æ›´æ–°å¤±è´¥",variant:"destructive"})}},ct=async()=>{if(a.trim()){me(!0);try{const t=a.split(",").map(A=>A.trim()).filter(Boolean);await S.inviteMembers(n,t),s({title:"æˆåŠŸ",description:"é‚€è¯·å·²å‘é€"}),te(!1),m("")}catch{s({title:"é”™è¯¯",description:"é‚€è¯·å¤±è´¥",variant:"destructive"})}finally{me(!1)}}},ot=async t=>{if(confirm("ç¡®å®šè¦ç§»é™¤è¯¥æˆå‘˜å—ï¼Ÿ")){ae(!0);try{await S.removeMember(n,t),I(A=>A.filter(U=>U.user_id!==t)),s({title:"æˆåŠŸ",description:"æˆå‘˜å·²ç§»é™¤"})}catch{s({title:"é”™è¯¯",description:"ç§»é™¤å¤±è´¥",variant:"destructive"})}finally{ae(!1)}}},dt=async t=>{ae(!0);try{await S.setAdmin(n,t),I(A=>A.map(U=>U.user_id===t?{...U,role:"admin"}:U)),s({title:"æˆåŠŸ",description:"å·²è®¾ä¸ºç®¡ç†å‘˜"})}catch{s({title:"é”™è¯¯",description:"æ“ä½œå¤±è´¥",variant:"destructive"})}finally{ae(!1)}},mt=async t=>{ae(!0);try{await S.removeAdmin(n,t),I(A=>A.map(U=>U.user_id===t?{...U,role:"member"}:U)),s({title:"æˆåŠŸ",description:"å·²å–æ¶ˆç®¡ç†å‘˜"})}catch{s({title:"é”™è¯¯",description:"æ“ä½œå¤±è´¥",variant:"destructive"})}finally{ae(!1)}},ut=async()=>{if(Ze){ae(!0);try{await S.muteMember(n,Ze.user_id,Qe),s({title:"æˆåŠŸ",description:`å·²ç¦è¨€ ${Qe} åˆ†é’Ÿ`}),Ee(!1),Te()}catch{s({title:"é”™è¯¯",description:"ç¦è¨€å¤±è´¥",variant:"destructive"})}finally{ae(!1)}}},xt=async t=>{ae(!0);try{await S.unmuteMember(n,t),Te(),s({title:"æˆåŠŸ",description:"å·²è§£é™¤ç¦è¨€"})}catch{s({title:"é”™è¯¯",description:"æ“ä½œå¤±è´¥",variant:"destructive"})}finally{ae(!1)}},ht=async t=>{if(confirm("ç¡®å®šè¦è½¬è®©ç¾¤ä¸»å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼")){ae(!0);try{await S.transferOwner(n,t),s({title:"æˆåŠŸ",description:"ç¾¤ä¸»å·²è½¬è®©"}),Te()}catch{s({title:"é”™è¯¯",description:"è½¬è®©å¤±è´¥",variant:"destructive"})}finally{ae(!1)}}},pt=async()=>{if(!(!Q.trim()||!c.trim())){ls(!0);try{await S.createNotice(n,{title:Q.trim(),content:c.trim(),is_pinned:u}),s({title:"æˆåŠŸ",description:"å…¬å‘Šå·²å‘å¸ƒ"}),K(!1),ue(""),X(""),q(!1),xs()}catch{s({title:"é”™è¯¯",description:"å‘å¸ƒå¤±è´¥",variant:"destructive"})}finally{ls(!1)}}},ft=async t=>{if(confirm("ç¡®å®šè¦åˆ é™¤è¯¥å…¬å‘Šå—ï¼Ÿ"))try{await S.deleteNotice(n,t),D(A=>A.filter(U=>U.id!==t)),s({title:"æˆåŠŸ",description:"å…¬å‘Šå·²åˆ é™¤"})}catch{s({title:"é”™è¯¯",description:"åˆ é™¤å¤±è´¥",variant:"destructive"})}},gt=async()=>{ms(!0);try{const t=await S.createInviteCode(n,{max_uses:cs,expires_in_hours:os});T(A=>[t,...A]),s({title:"æˆåŠŸ",description:`é‚€è¯·ç : ${t.code}`}),$e(!1)}catch{s({title:"é”™è¯¯",description:"ç”Ÿæˆå¤±è´¥",variant:"destructive"})}finally{ms(!1)}},jt=async t=>{try{await S.revokeInviteCode(n,t),T(A=>A.filter(U=>U.id!==t)),s({title:"æˆåŠŸ",description:"é‚€è¯·ç å·²æ’¤é”€"})}catch{s({title:"é”™è¯¯",description:"æ’¤é”€å¤±è´¥",variant:"destructive"})}},vt=t=>{navigator.clipboard.writeText(t),we(t),setTimeout(()=>we(null),2e3)},ps=t=>{const A=["bg-red-500","bg-orange-500","bg-amber-500","bg-green-500","bg-teal-500","bg-blue-500","bg-indigo-500","bg-purple-500"],U=t.split("").reduce((Pe,wt)=>Pe+wt.charCodeAt(0),0)%A.length;return A[U]},Nt=t=>t==="owner"?e.jsx(ns,{className:"h-4 w-4 text-yellow-500"}):t==="admin"?e.jsx(ss,{className:"h-4 w-4 text-blue-500"}):null,yt=t=>({open:"å¼€æ”¾å…¥ç¾¤",approval_required:"éœ€è¦å®¡æ ¸",invite_only:"ä»…é‚€è¯·",admin_invite_only:"ä»…ç®¡ç†å‘˜é‚€è¯·",closed:"ç¦æ­¢å…¥ç¾¤"})[t||"approval_required"];return j?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx(C,{className:"h-8 w-8 animate-spin"})}):e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"flex border-b overflow-x-auto",children:[{key:"info",label:"åŸºæœ¬ä¿¡æ¯",icon:rs,show:!0},{key:"members",label:"æˆå‘˜ç®¡ç†",icon:Se,show:!0},{key:"notices",label:"ç¾¤å…¬å‘Š",icon:Tt,show:!0},{key:"codes",label:"é‚€è¯·ç ",icon:Vs,show:!0},{key:"requests",label:"åŠ å…¥ç”³è¯·",icon:Ke,show:oe,badge:B.length}].filter(t=>t.show).map(t=>e.jsxs("button",{className:`flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap ${b===t.key?"border-primary text-primary":"border-transparent text-muted-foreground hover:text-foreground"}`,onClick:()=>k(t.key),children:[e.jsx(t.icon,{className:"h-4 w-4"}),t.label,t.badge&&t.badge>0&&e.jsx("span",{className:"bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-5 text-center",children:t.badge})]},t.key))}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:[b==="info"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsxs(ne,{className:"h-20 w-20",children:[e.jsx(xe,{src:g?.group_avatar_url}),e.jsx(ie,{className:"bg-gradient-to-br from-blue-500 to-purple-500 text-white text-2xl",children:g?.group_name?.[0]?.toUpperCase()})]}),oe&&e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:h,type:"file",accept:"image/*",className:"hidden",onChange:rt}),e.jsx("button",{className:"absolute bottom-0 right-0 bg-primary text-white rounded-full p-1.5 shadow-lg",onClick:()=>h.current?.click(),disabled:he,children:he?e.jsx(C,{className:"h-4 w-4 animate-spin"}):e.jsx(Ct,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex-1",children:[W?e.jsxs("div",{className:"flex gap-2",children:[e.jsx(O,{value:P,onChange:t=>Y(t.target.value),className:"flex-1"}),e.jsx(o,{size:"sm",onClick:nt,children:"ä¿å­˜"}),e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>v(!1),children:"å–æ¶ˆ"})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"text-xl font-semibold",children:g?.group_name}),oe&&e.jsx("button",{onClick:()=>v(!0),children:e.jsx(Ts,{className:"h-4 w-4 text-muted-foreground"})})]}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[g?.member_count," æˆå‘˜ Â· ",g?.status==="active"?"æ­£å¸¸":"å·²è§£æ•£"]})]})]}),e.jsxs(pe,{children:[e.jsx(Ce,{className:"pb-2",children:e.jsxs(ke,{className:"text-sm flex items-center justify-between",children:["ç¾¤ç®€ä»‹",oe&&!d&&e.jsx("button",{onClick:()=>H(!0),children:e.jsx(Ts,{className:"h-4 w-4 text-muted-foreground"})})]})}),e.jsx(fe,{children:d?e.jsxs("div",{className:"space-y-2",children:[e.jsx("textarea",{value:Z,onChange:t=>re(t.target.value),className:"w-full p-2 border rounded-lg resize-none h-24",placeholder:"è¾“å…¥ç¾¤ç®€ä»‹..."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{size:"sm",onClick:it,children:"ä¿å­˜"}),e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>H(!1),children:"å–æ¶ˆ"})]})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:g?.group_description||"æš‚æ— ç®€ä»‹"})})]}),Le&&e.jsxs(pe,{children:[e.jsx(Ce,{className:"pb-2",children:e.jsx(ke,{className:"text-sm",children:"å…¥ç¾¤æ¨¡å¼"})}),e.jsx(fe,{children:e.jsxs("select",{value:g?.join_mode||"approval_required",onChange:t=>lt(t.target.value),className:"w-full p-2 border rounded-lg",children:[e.jsx("option",{value:"open",children:"å¼€æ”¾å…¥ç¾¤ï¼ˆä»»ä½•äººå¯ç›´æŽ¥åŠ å…¥ï¼‰"}),e.jsx("option",{value:"approval_required",children:"éœ€è¦å®¡æ ¸ï¼ˆé»˜è®¤ï¼‰"}),e.jsx("option",{value:"invite_only",children:"ä»…é‚€è¯·ï¼ˆåªèƒ½é€šè¿‡é‚€è¯·åŠ å…¥ï¼‰"}),e.jsx("option",{value:"admin_invite_only",children:"ä»…ç®¡ç†å‘˜é‚€è¯·"}),e.jsx("option",{value:"closed",children:"ç¦æ­¢å…¥ç¾¤"})]})})]}),e.jsxs(pe,{children:[e.jsx(Ce,{className:"pb-2",children:e.jsx(ke,{className:"text-sm",children:"ç¾¤ä¿¡æ¯"})}),e.jsxs(fe,{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"ç¾¤ID"}),e.jsx("span",{className:"font-mono text-xs",children:g?.group_id})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"åˆ›å»ºæ—¶é—´"}),e.jsx("span",{children:g?.created_at?new Date(g.created_at).toLocaleDateString():"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"å…¥ç¾¤æ¨¡å¼"}),e.jsx("span",{children:yt(g?.join_mode)})]})]})]}),e.jsxs(pe,{className:"border-red-200",children:[e.jsx(Ce,{className:"pb-2",children:e.jsx(ke,{className:"text-sm text-red-600",children:"å±é™©æ“ä½œ"})}),e.jsxs(fe,{className:"space-y-2",children:[!Le&&e.jsxs(vs,{children:[e.jsx(Ns,{asChild:!0,children:e.jsxs(o,{variant:"outline",className:"w-full gap-2 text-red-600 border-red-200 hover:bg-red-50",children:[e.jsx(fs,{className:"h-4 w-4"}),"é€€å‡ºç¾¤èŠ"]})}),e.jsxs(ys,{children:[e.jsx(ws,{className:"fixed inset-0 bg-black/50"}),e.jsxs(_s,{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 w-96 shadow-xl",children:[e.jsx(bs,{className:"text-lg font-semibold",children:"ç¡®è®¤é€€å‡ºç¾¤èŠï¼Ÿ"}),e.jsx(Cs,{className:"text-sm text-muted-foreground mt-2",children:"é€€å‡ºåŽå°†ä¸å†æŽ¥æ”¶ç¾¤æ¶ˆæ¯ï¼Œéœ€è¦é‡æ–°ç”³è¯·æˆ–è¢«é‚€è¯·æ‰èƒ½å†æ¬¡åŠ å…¥ã€‚"}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx(ks,{asChild:!0,children:e.jsx(o,{variant:"ghost",children:"å–æ¶ˆ"})}),e.jsx(Ss,{asChild:!0,children:e.jsx(o,{variant:"destructive",onClick:async()=>{await S.leaveGroup(n),s({title:"æˆåŠŸ",description:"å·²é€€å‡ºç¾¤èŠ"}),r?.()},children:"ç¡®è®¤é€€å‡º"})})]})]})]})]}),Le&&e.jsxs(vs,{children:[e.jsx(Ns,{asChild:!0,children:e.jsxs(o,{variant:"destructive",className:"w-full gap-2",children:[e.jsx(Re,{className:"h-4 w-4"}),"è§£æ•£ç¾¤èŠ"]})}),e.jsxs(ys,{children:[e.jsx(ws,{className:"fixed inset-0 bg-black/50"}),e.jsxs(_s,{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 w-96 shadow-xl",children:[e.jsx(bs,{className:"text-lg font-semibold",children:"ç¡®è®¤è§£æ•£ç¾¤èŠï¼Ÿ"}),e.jsx(Cs,{className:"text-sm text-muted-foreground mt-2",children:"æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œç¾¤èŠå°†è¢«æ°¸ä¹…åˆ é™¤ã€‚"}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx(ks,{asChild:!0,children:e.jsx(o,{variant:"ghost",children:"å–æ¶ˆ"})}),e.jsx(Ss,{asChild:!0,children:e.jsx(o,{variant:"destructive",onClick:async()=>{await S.disbandGroup(n),s({title:"æˆåŠŸ",description:"ç¾¤èŠå·²è§£æ•£"}),r?.()},children:"ç¡®è®¤è§£æ•£"})})]})]})]})]})]})]})]}),b==="members"&&e.jsxs("div",{className:"space-y-4",children:[oe&&e.jsxs(o,{className:"w-full gap-2",onClick:()=>te(!0),children:[e.jsx(Ke,{className:"h-4 w-4"}),"é‚€è¯·æˆå‘˜"]}),w?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(C,{className:"h-6 w-6 animate-spin"})}):e.jsx("div",{className:"space-y-2",children:$.map(t=>e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsxs(ne,{className:"h-10 w-10",children:[e.jsx(xe,{src:t.user_avatar_url}),e.jsx(ie,{className:ps(t.user_nickname)+" text-white",children:t.user_nickname[0]?.toUpperCase()})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium truncate",children:t.group_nickname||t.user_nickname}),Nt(t.role),t.muted_until&&new Date(t.muted_until)>new Date&&e.jsx(As,{className:"h-4 w-4 text-red-500"})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t.role==="owner"?"ç¾¤ä¸»":t.role==="admin"?"ç®¡ç†å‘˜":"æˆå‘˜"})]}),oe&&t.user_id!==x?.user_id&&t.role!=="owner"&&e.jsxs("div",{className:"flex gap-1",children:[t.muted_until&&new Date(t.muted_until)>new Date?e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>xt(t.user_id),disabled:Ne,children:e.jsx(Yt,{className:"h-4 w-4 text-green-500"})}):e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>{Zs(t),Ee(!0)},disabled:Ne,children:e.jsx(As,{className:"h-4 w-4 text-orange-500"})}),Le&&e.jsxs(e.Fragment,{children:[t.role==="admin"?e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>mt(t.user_id),disabled:Ne,children:e.jsx(ss,{className:"h-4 w-4 text-gray-400"})}):e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>dt(t.user_id),disabled:Ne,children:e.jsx(ss,{className:"h-4 w-4 text-blue-500"})}),e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>ht(t.user_id),disabled:Ne,children:e.jsx(ns,{className:"h-4 w-4 text-yellow-500"})})]}),e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>ot(t.user_id),disabled:Ne,children:e.jsx(fs,{className:"h-4 w-4 text-red-500"})})]})]},t.user_id))})]}),b==="notices"&&e.jsxs("div",{className:"space-y-4",children:[oe&&e.jsxs(o,{className:"w-full gap-2",onClick:()=>K(!0),children:[e.jsx(Ye,{className:"h-4 w-4"}),"å‘å¸ƒå…¬å‘Š"]}),E?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(C,{className:"h-6 w-6 animate-spin"})}):y.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"æš‚æ— å…¬å‘Š"}):e.jsx("div",{className:"space-y-4",children:y.map(t=>e.jsx(pe,{className:t.is_pinned?"border-primary":"",children:e.jsx(fe,{className:"pt-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[t.is_pinned&&e.jsx("span",{className:"text-xs text-primary font-medium",children:"ðŸ“Œ ç½®é¡¶"}),e.jsx("h4",{className:"font-medium",children:t.title}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2 whitespace-pre-wrap",children:t.content}),e.jsxs("div",{className:"flex items-center gap-2 mt-3 text-xs text-muted-foreground",children:[e.jsx("span",{children:t.publisher_nickname}),e.jsx("span",{children:"Â·"}),e.jsx("span",{children:new Date(t.published_at).toLocaleDateString()})]})]}),oe&&e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>ft(t.id),children:e.jsx(Re,{className:"h-4 w-4 text-red-500"})})]})})},t.id))})]}),b==="codes"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs(o,{className:"w-full gap-2",onClick:()=>$e(!0),children:[e.jsx(Ye,{className:"h-4 w-4"}),"ç”Ÿæˆé‚€è¯·ç "]}),R?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(C,{className:"h-6 w-6 animate-spin"})}):M.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"æš‚æ— é‚€è¯·ç "}):e.jsx("div",{className:"space-y-2",children:M.map(t=>e.jsx(pe,{children:e.jsx(fe,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-mono text-lg font-bold",children:t.code}),e.jsx("span",{className:`text-xs px-2 py-0.5 rounded ${t.code_type==="direct"?"bg-green-100 text-green-700":"bg-yellow-100 text-yellow-700"}`,children:t.code_type==="direct"?"ç›´æŽ¥å…¥ç¾¤":"éœ€å®¡æ ¸"})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["æœ‰æ•ˆæœŸè‡³: ",new Date(t.expires_at).toLocaleString()]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>vt(t.code),children:le===t.code?e.jsx(Xe,{className:"h-4 w-4 text-green-500"}):e.jsx(Be,{className:"h-4 w-4"})}),oe&&e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>jt(t.id),children:e.jsx(Re,{className:"h-4 w-4 text-red-500"})})]})]})})},t.id))})]}),b==="requests"&&oe&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"å¾…å¤„ç†çš„åŠ å…¥ç”³è¯·"}),e.jsx(o,{variant:"ghost",size:"sm",onClick:hs,disabled:G,children:G?e.jsx(C,{className:"h-4 w-4 animate-spin"}):"åˆ·æ–°"})]}),G?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(C,{className:"h-6 w-6 animate-spin"})}):B.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"æš‚æ— åŠ å…¥ç”³è¯·"}):e.jsx("div",{className:"space-y-2",children:B.map(t=>e.jsx(pe,{children:e.jsx(fe,{className:"pt-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs(ne,{className:"h-10 w-10",children:[e.jsx(xe,{src:t.user_avatar_url}),e.jsx(ie,{className:ps(t.user_nickname)+" text-white",children:t.user_nickname[0]?.toUpperCase()})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium",children:t.user_nickname}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.user_id}),t.reason&&e.jsx("div",{className:"text-sm text-muted-foreground mt-1 p-2 bg-gray-50 rounded",children:t.reason}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["ç”³è¯·æ—¶é—´: ",new Date(t.created_at).toLocaleString()]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(o,{size:"sm",onClick:()=>tt(t.request_id),disabled:l===t.request_id,children:l===t.request_id?e.jsx(C,{className:"h-4 w-4 animate-spin"}):e.jsx(Xe,{className:"h-4 w-4"})}),e.jsx(o,{variant:"outline",size:"sm",onClick:()=>at(t.request_id),disabled:l===t.request_id,children:e.jsx(Ae,{className:"h-4 w-4"})})]})]})})},t.request_id))})]})]}),e.jsx(Ie,{open:ve,onOpenChange:te,children:e.jsxs(Ge,{children:[e.jsx(He,{className:"fixed inset-0 bg-black/50"}),e.jsxs(qe,{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 w-96 shadow-xl",children:[e.jsx(Oe,{className:"text-lg font-semibold",children:"é‚€è¯·æˆå‘˜"}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"ç”¨æˆ·IDï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰"}),e.jsx(O,{value:a,onChange:t=>m(t.target.value),placeholder:"user1, user2, user3",className:"mt-1"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(o,{variant:"ghost",onClick:()=>te(!1),children:"å–æ¶ˆ"}),e.jsx(o,{onClick:ct,disabled:z,children:z?e.jsx(C,{className:"h-4 w-4 animate-spin"}):"é‚€è¯·"})]})]})]})]})}),e.jsx(Ie,{open:ce,onOpenChange:K,children:e.jsxs(Ge,{children:[e.jsx(He,{className:"fixed inset-0 bg-black/50"}),e.jsxs(qe,{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 w-96 shadow-xl",children:[e.jsx(Oe,{className:"text-lg font-semibold",children:"å‘å¸ƒå…¬å‘Š"}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"æ ‡é¢˜"}),e.jsx(O,{value:Q,onChange:t=>ue(t.target.value),placeholder:"å…¬å‘Šæ ‡é¢˜",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"å†…å®¹"}),e.jsx("textarea",{value:c,onChange:t=>X(t.target.value),placeholder:"å…¬å‘Šå†…å®¹",className:"mt-1 w-full p-2 border rounded-lg resize-none h-32"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:u,onChange:t=>q(t.target.checked)}),e.jsx("span",{className:"text-sm",children:"ç½®é¡¶å…¬å‘Š"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(o,{variant:"ghost",onClick:()=>K(!1),children:"å–æ¶ˆ"}),e.jsx(o,{onClick:pt,disabled:ze,children:ze?e.jsx(C,{className:"h-4 w-4 animate-spin"}):"å‘å¸ƒ"})]})]})]})]})}),e.jsx(Ie,{open:Ks,onOpenChange:$e,children:e.jsxs(Ge,{children:[e.jsx(He,{className:"fixed inset-0 bg-black/50"}),e.jsxs(qe,{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 w-96 shadow-xl",children:[e.jsx(Oe,{className:"text-lg font-semibold",children:"ç”Ÿæˆé‚€è¯·ç "}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"æœ€å¤§ä½¿ç”¨æ¬¡æ•°"}),e.jsx(O,{type:"number",value:cs,onChange:t=>Xs(parseInt(t.target.value)||1),min:1,className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"æœ‰æ•ˆæœŸï¼ˆå°æ—¶ï¼‰"}),e.jsx(O,{type:"number",value:os,onChange:t=>Ys(parseInt(t.target.value)||1),min:1,max:168,className:"mt-1"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(o,{variant:"ghost",onClick:()=>$e(!1),children:"å–æ¶ˆ"}),e.jsx(o,{onClick:gt,disabled:ds,children:ds?e.jsx(C,{className:"h-4 w-4 animate-spin"}):"ç”Ÿæˆ"})]})]})]})]})}),e.jsx(Ie,{open:Qs,onOpenChange:Ee,children:e.jsxs(Ge,{children:[e.jsx(He,{className:"fixed inset-0 bg-black/50"}),e.jsxs(qe,{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 w-96 shadow-xl",children:[e.jsxs(Oe,{className:"text-lg font-semibold",children:["ç¦è¨€æˆå‘˜: ",Ze?.user_nickname]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"ç¦è¨€æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰"}),e.jsx(O,{type:"number",value:Qe,onChange:t=>us(parseInt(t.target.value)||1),min:1,className:"mt-1"})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:[10,30,60,360,1440].map(t=>e.jsx(o,{variant:"outline",size:"sm",onClick:()=>us(t),children:t<60?`${t}åˆ†é’Ÿ`:`${t/60}å°æ—¶`},t))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(o,{variant:"ghost",onClick:()=>Ee(!1),children:"å–æ¶ˆ"}),e.jsx(o,{onClick:ut,disabled:Ne,children:Ne?e.jsx(C,{className:"h-4 w-4 animate-spin"}):"ç¡®è®¤ç¦è¨€"})]})]})]})]})})]})}function la(){const{toast:n}=Me(),{user:r}=_e(),{selectedConversation:s,messages:x,setMessages:h,addMessage:g,prependMessages:p,messageInput:j,setMessageInput:N,getTypingUsers:$,typingUsers:I}=Ue(),[w,_]=i.useState(!1),[y,D]=i.useState(!1),[E,F]=i.useState(!0),[M,T]=i.useState(null),[R,L]=i.useState(null),[B,J]=i.useState(!1),G=i.useRef(null),V=i.useRef(null),l=i.useRef(null);i.useEffect(()=>{if(!s){h([]);return}f()},[s]),i.useEffect(()=>{W()},[x]);const f=async()=>{if(!(!s||w)){_(!0);try{if(s.type==="friend"){const a=await ye.getMessages(s.id,void 0,50);h(a.messages),F(a.has_more)}else if(s.type==="group"){const a=await be.getMessages(s.id,void 0,50);h(a.messages),F(a.has_more)}}catch(a){console.error("åŠ è½½æ¶ˆæ¯å¤±è´¥:",a),n({title:"é”™è¯¯",description:"åŠ è½½æ¶ˆæ¯å¤±è´¥",variant:"destructive"})}finally{_(!1)}}},b=async()=>{if(!(!s||w||!E||x.length===0)){_(!0);try{const a=x[0].send_time;if(s.type==="friend"){const m=await ye.getMessages(s.id,a,50);p(m.messages),F(m.has_more)}else if(s.type==="group"){const m=await be.getMessages(s.id,a,50);p(m.messages),F(m.has_more)}}catch(a){console.error("åŠ è½½æ›´å¤šæ¶ˆæ¯å¤±è´¥:",a)}finally{_(!1)}}},k=()=>{const a=V.current;a&&a.scrollTop===0&&E&&!w&&b()},W=()=>{G.current?.scrollIntoView({behavior:"smooth"})},v=async()=>{if(!s||!j.trim()||y)return;const a=j.trim();N(""),D(!0);try{if(s.type==="friend"){const m=await ye.sendMessage({receiver_id:s.id,message_content:a,message_type:"text"}),z={message_uuid:m.message_uuid,sender_id:r?.user_id||"",receiver_id:s.id,message_content:a,message_type:"text",file_uuid:null,file_url:null,file_size:null,send_time:m.send_time};g(z)}else if(s.type==="group"){const m=await be.sendMessage({group_id:s.id,message_content:a,message_type:"text"}),z={message_uuid:m.message_uuid,sender_id:r?.user_id||"",receiver_id:s.id,message_content:a,message_type:"text",file_uuid:null,file_url:null,file_size:null,send_time:m.send_time};g(z)}}catch(m){console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",m),n({title:"å‘é€å¤±è´¥",description:m instanceof Error?m.message:"å‘é€æ¶ˆæ¯å¤±è´¥",variant:"destructive"}),N(a)}finally{D(!1)}},P=a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),v())},Y=a=>{const m=a.target.files?.[0];if(m){if(m.size>100*1024*1024*1024){n({title:"æ–‡ä»¶å¤ªå¤§",description:"æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 100GB",variant:"destructive"});return}L(m)}l.current&&(l.current.value="")},d=()=>{L(null),T(null)},H=a=>{const m=a.type;return m.startsWith("image/")?{type:s?.type==="friend"?"friend_image":"group_image",messageType:"image"}:m.startsWith("video/")?{type:s?.type==="friend"?"friend_video":"group_video",messageType:"video"}:{type:s?.type==="friend"?"friend_document":"group_document",messageType:"file"}},Z=async()=>{if(!s||!R||y)return;const a=R;L(null),D(!0),T(0);try{const{type:m,messageType:z}=H(a),me=s.type==="friend"?"friend_messages":"group_files",ce=await je.uploadFile(a,m,me,s.id,K=>{T(K.percent)});if(ce.messageUuid)await f(),n({title:"å‘é€æˆåŠŸ",description:ce.isInstant?"æ–‡ä»¶ç§’ä¼ æˆåŠŸ":"æ–‡ä»¶å‘é€æˆåŠŸ"});else{const K=ce.fileUrl.split("/").pop()||"";if(s.type==="friend"){const Q=await ye.sendMessage({receiver_id:s.id,message_content:a.name,message_type:z,file_uuid:K,file_size:a.size}),ue={message_uuid:Q.message_uuid,sender_id:r?.user_id||"",receiver_id:s.id,message_content:a.name,message_type:z,file_uuid:K,file_url:ce.fileUrl,file_size:a.size,send_time:Q.send_time};g(ue)}else if(s.type==="group"){const Q=await be.sendMessage({group_id:s.id,message_content:a.name,message_type:z,file_uuid:K,file_size:a.size}),ue={message_uuid:Q.message_uuid,sender_id:r?.user_id||"",receiver_id:s.id,message_content:a.name,message_type:z,file_uuid:K,file_url:ce.fileUrl,file_size:a.size,send_time:Q.send_time};g(ue)}n({title:"å‘é€æˆåŠŸ",description:"æ–‡ä»¶å‘é€æˆåŠŸ"})}}catch(m){console.error("å‘é€æ–‡ä»¶å¤±è´¥:",m),n({title:"å‘é€å¤±è´¥",description:m instanceof Error?m.message:"æ–‡ä»¶å‘é€å¤±è´¥",variant:"destructive"})}finally{D(!1),T(null)}},re=async a=>{try{s?.type==="friend"?await ye.deleteMessage(a):s?.type==="group"&&await be.deleteMessage(a),h(x.filter(m=>m.message_uuid!==a)),n({title:"æˆåŠŸ",description:"æ¶ˆæ¯å·²åˆ é™¤"})}catch(m){n({title:"åˆ é™¤å¤±è´¥",description:m instanceof Error?m.message:"åˆ é™¤æ¶ˆæ¯å¤±è´¥",variant:"destructive"})}},he=async a=>{try{s?.type==="friend"?await ye.recallMessage(a):s?.type==="group"&&await be.recallMessage(a),h(x.filter(m=>m.message_uuid!==a)),n({title:"æˆåŠŸ",description:"æ¶ˆæ¯å·²æ’¤å›ž"})}catch(m){n({title:"æ’¤å›žå¤±è´¥",description:m instanceof Error?m.message:"æ’¤å›žæ¶ˆæ¯å¤±è´¥ï¼ˆå¯èƒ½è¶…è¿‡2åˆ†é’Ÿï¼‰",variant:"destructive"})}},de=a=>{const m=new Date(a).getTime();return Date.now()-m<=120*1e3},le=async a=>{try{if(a.file_uuid){const m=s?.type==="friend"?await je.getFriendFilePresignedUrl(a.file_uuid,"preview"):await je.getPresignedUrl(a.file_uuid,"preview");window.open(m,"_blank")}else a.file_url&&window.open(a.file_url,"_blank")}catch(m){n({title:"é¢„è§ˆå¤±è´¥",description:m instanceof Error?m.message:"æ— æ³•é¢„è§ˆæ–‡ä»¶",variant:"destructive"})}},we=async a=>{try{let m;if(a.file_uuid)m=s?.type==="friend"?await je.getFriendFilePresignedUrl(a.file_uuid,"download"):await je.getPresignedUrl(a.file_uuid,"download");else if(a.file_url)m=a.file_url;else throw new Error("æ–‡ä»¶ä¸å¯ç”¨");const z=document.createElement("a");z.href=m,z.download=a.message_content||"download",document.body.appendChild(z),z.click(),document.body.removeChild(z)}catch(m){n({title:"ä¸‹è½½å¤±è´¥",description:m instanceof Error?m.message:"æ— æ³•ä¸‹è½½æ–‡ä»¶",variant:"destructive"})}},ve=a=>{switch(a.message_type){case"text":return e.jsx("p",{className:"whitespace-pre-wrap break-words",children:a.message_content});case"image":return e.jsx("div",{className:"space-y-2",children:a.file_url||a.file_uuid?e.jsx("div",{className:"cursor-pointer hover:opacity-90",onClick:()=>le(a),children:e.jsx("img",{src:a.file_url||`${window.location.origin}/api/storage/file/${a.file_uuid}`,alt:"å›¾ç‰‡",className:"max-w-xs rounded-lg",loading:"lazy"})}):e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(gs,{className:"h-4 w-4"}),e.jsx("span",{children:"[å›¾ç‰‡]"})]})});case"video":return e.jsx("div",{className:"space-y-2",children:a.file_url||a.file_uuid?e.jsx("video",{src:a.file_url||void 0,controls:!0,className:"max-w-xs rounded-lg",onClick:m=>{m.stopPropagation(),le(a)}}):e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Fe,{className:"h-4 w-4"}),e.jsx("span",{children:"[è§†é¢‘]"})]})});case"file":return e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-background/50 rounded-lg",children:[e.jsx(De,{className:"h-8 w-8 text-blue-500"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:a.message_content||"æ–‡ä»¶"}),a.file_size&&e.jsx("p",{className:"text-xs text-muted-foreground",children:te(a.file_size)})]}),(a.file_url||a.file_uuid)&&e.jsx(o,{variant:"ghost",size:"icon",className:"shrink-0",onClick:()=>we(a),children:e.jsx(Bs,{className:"h-4 w-4"})})]});default:return e.jsx("p",{className:"text-sm",children:"[ä¸æ”¯æŒçš„æ¶ˆæ¯ç±»åž‹]"})}},te=a=>a<1024?a+" B":a<1024*1024?(a/1024).toFixed(1)+" KB":a<1024*1024*1024?(a/1024/1024).toFixed(1)+" MB":(a/1024/1024/1024).toFixed(1)+" GB";return s?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("header",{className:"h-16 border-b bg-card flex items-center justify-between px-6 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ne,{className:"h-10 w-10",children:[e.jsx(xe,{src:s.avatar}),e.jsx(ie,{children:s.name[0]?.toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:s.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.type==="friend"?"å¥½å‹":"ç¾¤èŠ"})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[s.type==="group"&&e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>J(!0),title:"ç¾¤ç®¡ç†",children:e.jsx(rs,{className:"h-5 w-5"})}),e.jsx(o,{variant:"ghost",size:"icon",children:e.jsx(Ps,{className:"h-5 w-5"})})]})]}),e.jsx("div",{ref:V,className:"flex-1 overflow-y-auto p-6 space-y-4",onScroll:k,children:w&&x.length===0?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(C,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):x.length===0?e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:e.jsx("p",{className:"text-sm",children:"æš‚æ— æ¶ˆæ¯ï¼Œå¼€å§‹èŠå¤©å§ï¼"})}):e.jsxs(e.Fragment,{children:[E&&e.jsx("div",{className:"text-center",children:e.jsx(o,{variant:"ghost",size:"sm",onClick:b,disabled:w,children:w?e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"h-4 w-4 mr-2 animate-spin"}),"åŠ è½½ä¸­..."]}):"åŠ è½½æ›´å¤š"})}),x.map(a=>{const m=a.sender_id===r?.user_id,z=s.type==="group"?a:null,me=m&&de(a.send_time);return e.jsxs("div",{className:`flex gap-3 ${m?"flex-row-reverse":"flex-row"} group`,children:[e.jsxs(ne,{className:"h-10 w-10 shrink-0",children:[z&&e.jsx(xe,{src:z.sender_avatar_url}),e.jsx(ie,{children:z?z.sender_nickname[0]?.toUpperCase():m?r?.nickname?.[0]?.toUpperCase()||"U":s.name[0]?.toUpperCase()})]}),e.jsxs("div",{className:`flex flex-col gap-1 max-w-[70%] ${m?"items-end":"items-start"}`,children:[z&&!m&&e.jsx("span",{className:"text-xs text-muted-foreground px-2",children:z.sender_nickname}),e.jsxs(Gs,{children:[e.jsx(Hs,{asChild:!0,children:e.jsx("div",{className:`rounded-2xl px-4 py-2 cursor-pointer hover:shadow-md transition-shadow ${m?"bg-primary text-primary-foreground":"bg-muted"}`,children:ve(a)})}),e.jsx(qs,{children:e.jsxs(Os,{className:"min-w-[120px] bg-white rounded-lg shadow-xl border p-1 z-50",sideOffset:5,children:[me&&e.jsxs(is,{className:"flex items-center gap-2 px-3 py-2 text-sm cursor-pointer hover:bg-gray-100 rounded outline-none",onSelect:()=>he(a.message_uuid),children:[e.jsx(Rt,{size:14}),"æ’¤å›ž"]}),e.jsxs(is,{className:"flex items-center gap-2 px-3 py-2 text-sm cursor-pointer hover:bg-gray-100 rounded outline-none text-red-600",onSelect:()=>re(a.message_uuid),children:[e.jsx(Re,{size:14}),"åˆ é™¤"]})]})})]}),e.jsx("span",{className:"text-xs text-muted-foreground px-2",children:new Date(a.send_time).toLocaleTimeString()})]})]},a.message_uuid)}),e.jsx("div",{ref:G}),s&&(()=>{const a=$(s.id);return a.length===0?null:e.jsxs("div",{className:"px-4 py-2 text-sm text-muted-foreground flex items-center gap-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsx("span",{children:s.type==="friend"?"å¯¹æ–¹æ­£åœ¨è¾“å…¥...":a.length===1?"æœ‰äººæ­£åœ¨è¾“å…¥...":`${a.length} äººæ­£åœ¨è¾“å…¥...`})]})})()]})}),e.jsxs("div",{className:"border-t bg-card p-4 shrink-0",children:[R&&e.jsxs("div",{className:"mb-3 p-3 bg-muted rounded-lg flex items-center gap-3",children:[R.type.startsWith("image/")?e.jsx(gs,{className:"h-8 w-8 text-blue-500"}):R.type.startsWith("video/")?e.jsx(Fe,{className:"h-8 w-8 text-purple-500"}):e.jsx(De,{className:"h-8 w-8 text-gray-500"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:R.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:te(R.size)})]}),e.jsx(o,{variant:"ghost",size:"icon",onClick:d,disabled:y,children:e.jsx(Ae,{className:"h-4 w-4"})})]}),M!==null&&e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground mb-1",children:[e.jsx("span",{children:"ä¸Šä¼ ä¸­..."}),e.jsxs("span",{children:[M.toFixed(1),"%"]})]}),e.jsx("div",{className:"h-2 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary transition-all duration-200",style:{width:`${M}%`}})})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("input",{ref:l,type:"file",className:"hidden",onChange:Y,accept:"image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar"}),e.jsx(o,{variant:"ghost",size:"icon",className:"shrink-0",onClick:()=>l.current?.click(),disabled:y,children:e.jsx(bt,{className:"h-5 w-5"})}),e.jsx(o,{variant:"ghost",size:"icon",className:"shrink-0",children:e.jsx(Wt,{className:"h-5 w-5"})}),e.jsx(O,{placeholder:"è¾“å…¥æ¶ˆæ¯...",value:j,onChange:a=>N(a.target.value),onKeyPress:P,className:"flex-1",disabled:y}),e.jsx(o,{onClick:R?Z:v,disabled:!j.trim()&&!R||y,className:"shrink-0",children:y?e.jsx(C,{className:"h-5 w-5 animate-spin"}):e.jsx(Ws,{className:"h-5 w-5"})})]})]}),B&&s?.type==="group"&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-card rounded-lg w-[90vw] max-w-2xl h-[80vh] max-h-[700px] shadow-xl flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"ç¾¤ç®¡ç†"}),e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>J(!1),children:e.jsx(Ae,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(ra,{groupId:s.id,onClose:()=>J(!1)})})]})})]}):e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-6xl mb-4",children:"ðŸ’¬"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"HuanVae Chat"}),e.jsx("p",{className:"text-sm",children:"é€‰æ‹©ä¸€ä¸ªä¼šè¯å¼€å§‹èŠå¤©"})]})})}function ca({subTab:n}){const{toast:r}=Me(),s=i.useRef(null),[x,h]=i.useState([]),[g,p]=i.useState(!1),[j,N]=i.useState(!1),[$,I]=i.useState(0),[w,_]=i.useState("personal"),[y,D]=i.useState(1),[E,F]=i.useState(!0),M=async(l=!1)=>{if(!g){p(!0);try{const f=l?1:y,b=await je.getFileList(f,20,"created_at","desc");l?(h(b.files),D(1)):h(k=>[...k,...b.files]),F(b.has_more),!l&&b.has_more&&D(k=>k+1)}catch(f){r({title:"åŠ è½½å¤±è´¥",description:f instanceof Error?f.message:"èŽ·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥",variant:"destructive"})}finally{p(!1)}}};i.useEffect(()=>{n==="main"&&M(!0)},[n]);const T=l=>l.startsWith("image/")?"user_image":l.startsWith("video/")?"user_video":"user_document",R=()=>{switch(w){case"friend":return"friend_messages";case"group":return"group_files";default:return"user_files"}},L=async l=>{const f=l.target.files?.[0];if(!f)return;const b=500*1024*1024;if(f.size>b){r({title:"æ–‡ä»¶è¿‡å¤§",description:`æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ ${js(b)}`,variant:"destructive"});return}N(!0),I(0);try{const k=T(f.type),W=R(),v=await je.uploadFile(f,k,W,void 0,P=>{I(Math.round(P.percent))});r({title:v.isInstant?"ç§’ä¼ æˆåŠŸ":"ä¸Šä¼ æˆåŠŸ",description:`${f.name} å·²ä¸Šä¼ `}),M(!0)}catch(k){r({title:"ä¸Šä¼ å¤±è´¥",description:k instanceof Error?k.message:"ä¸Šä¼ æ–‡ä»¶å¤±è´¥",variant:"destructive"})}finally{N(!1),I(0),s.current&&(s.current.value="")}},B=async l=>{try{const f=await je.getPresignedUrl(l.file_uuid,"download"),b=document.createElement("a");b.href=f,b.download=l.filename,document.body.appendChild(b),b.click(),document.body.removeChild(b)}catch(f){r({title:"ä¸‹è½½å¤±è´¥",description:f instanceof Error?f.message:"èŽ·å–ä¸‹è½½é“¾æŽ¥å¤±è´¥",variant:"destructive"})}},J=async l=>{try{const f=await je.getPresignedUrl(l.file_uuid,"preview");window.open(f,"_blank")}catch(f){r({title:"é¢„è§ˆå¤±è´¥",description:f instanceof Error?f.message:"èŽ·å–é¢„è§ˆé“¾æŽ¥å¤±è´¥",variant:"destructive"})}},G=l=>l.startsWith("image/")?Ut:l.startsWith("video/")?Et:De,V=l=>new Date(l).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return n==="main"?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"p-3 border-b flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["å…± ",x.length," ä¸ªæ–‡ä»¶"]}),e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>M(!0),disabled:g,children:e.jsx(ts,{className:`h-4 w-4 ${g?"animate-spin":""}`})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:g&&x.length===0?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(C,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):x.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-muted-foreground",children:[e.jsx(Pt,{className:"h-12 w-12 mb-4"}),e.jsx("p",{className:"text-sm",children:"æš‚æ— æ–‡ä»¶"}),e.jsx("p",{className:"text-xs mt-1",children:"ä¸Šä¼ æ–‡ä»¶åŽå°†åœ¨è¿™é‡Œæ˜¾ç¤º"})]}):e.jsxs("div",{className:"divide-y",children:[x.map(l=>{const f=G(l.content_type);return e.jsx("div",{className:"p-3 hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center",children:e.jsx(f,{className:"h-5 w-5 text-blue-500"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:l.filename}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[js(l.file_size)," Â· ",V(l.created_at)]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[l.preview_support==="inline_preview"&&e.jsx(o,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>J(l),children:e.jsx(kt,{className:"h-4 w-4"})}),e.jsx(o,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>B(l),children:e.jsx(Bs,{className:"h-4 w-4"})})]})]})},l.file_uuid)}),E&&e.jsx("div",{className:"p-4 text-center",children:e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>M(),disabled:g,children:[g?e.jsx(C,{className:"h-4 w-4 animate-spin mr-2"}):null,"åŠ è½½æ›´å¤š"]})})]})})]}):n==="upload"?e.jsx("div",{className:"flex flex-col h-full",children:e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[e.jsxs("div",{className:"border-2 border-dashed rounded-lg p-8 text-center",children:[e.jsx(Rs,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("h3",{className:"font-semibold mb-2",children:"ä¸Šä¼ æ–‡ä»¶"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ "}),e.jsx("p",{className:"text-xs text-muted-foreground mb-6",children:"æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€æ–‡æ¡£ï¼Œæœ€å¤§ 500MB"}),j&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2 mb-2",children:e.jsx("div",{className:"bg-primary h-2 rounded-full transition-all",style:{width:`${$}%`}})}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["ä¸Šä¼ ä¸­ ",$,"%"]})]}),e.jsx("input",{ref:s,type:"file",className:"hidden",onChange:L,disabled:j,accept:"image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar"}),e.jsx(o,{onClick:()=>s.current?.click(),disabled:j,children:j?e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"h-4 w-4 mr-2 animate-spin"}),"ä¸Šä¼ ä¸­..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Rs,{className:"h-4 w-4 mr-2"}),"é€‰æ‹©æ–‡ä»¶"]})}),e.jsxs("div",{className:"mt-8 space-y-2",children:[e.jsx("h4",{className:"text-sm font-medium",children:"å­˜å‚¨ä½ç½®"}),e.jsxs("div",{className:"flex gap-2 justify-center",children:[e.jsx(o,{variant:w==="personal"?"default":"outline",size:"sm",onClick:()=>_("personal"),children:"ä¸ªäººæ–‡ä»¶"}),e.jsx(o,{variant:w==="friend"?"default":"outline",size:"sm",onClick:()=>_("friend"),children:"å‘é€ç»™å¥½å‹"}),e.jsx(o,{variant:w==="group"?"default":"outline",size:"sm",onClick:()=>_("group"),children:"å‘é€åˆ°ç¾¤èŠ"})]})]})]}),e.jsxs("div",{className:"mt-6 p-4 bg-blue-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-sm mb-2",children:"ä¸Šä¼ è¯´æ˜Ž"}),e.jsxs("ul",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("li",{children:"â€¢ ç›¸åŒæ–‡ä»¶æ”¯æŒç§’ä¼ ï¼Œæ— éœ€é‡å¤ä¸Šä¼ "}),e.jsx("li",{children:"â€¢ å¤§æ–‡ä»¶è‡ªåŠ¨åˆ†ç‰‡ä¸Šä¼ ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ "}),e.jsx("li",{children:"â€¢ ä¸Šä¼ çš„æ–‡ä»¶å°†ä¿å­˜åœ¨æ‚¨çš„ä¸ªäººç©ºé—´"})]})]})]})}):null}function oa(){const n=Ls(),{toast:r}=Me(),{accessToken:s}=_e(),[x,h]=i.useState(!1),[g,p]=i.useState(!1),[j,N]=i.useState(!1),[$,I]=i.useState(!1),[w,_]=i.useState(""),[y,D]=i.useState(""),[E,F]=i.useState(5),[M,T]=i.useState(60),[R,L]=i.useState(""),[B,J]=i.useState(""),[G,V]=i.useState(""),[l,f]=i.useState(null),b=async()=>{N(!0);try{const v=await Ms.createRoom({name:w||void 0,password:y||void 0,max_participants:E,expires_minutes:M}),P=`${window.location.origin}/video-meeting?room=${v.room_id}&pwd=${y||""}`;f({roomId:v.room_id,password:y||"æ— ",shareLink:P}),r({title:"æˆåŠŸ",description:"æˆ¿é—´åˆ›å»ºæˆåŠŸï¼æ­£åœ¨è·³è½¬..."}),h(!1);const Y=new URLSearchParams({room:v.room_id,token:s||"",creator:"true"});y&&Y.set("pwd",y),n(`/video-meeting?${Y.toString()}`)}catch(v){r({title:"åˆ›å»ºå¤±è´¥",description:v instanceof Error?v.message:"åˆ›å»ºæˆ¿é—´å¤±è´¥",variant:"destructive"})}finally{N(!1)}},k=async()=>{if(!R.trim()){r({title:"é”™è¯¯",description:"è¯·è¾“å…¥æˆ¿é—´å·",variant:"destructive"});return}I(!0);try{const v=await Ms.joinRoom(R,{password:B||"",display_name:G||"Anonymous"});r({title:"æˆåŠŸ",description:"å·²åŠ å…¥æˆ¿é—´ï¼æ­£åœ¨è·³è½¬..."}),p(!1);const P=new URLSearchParams({room:R,token:v.ws_token||""});G&&P.set("name",G),n(`/video-meeting?${P.toString()}`)}catch(v){r({title:"åŠ å…¥å¤±è´¥",description:v instanceof Error?v.message:"åŠ å…¥æˆ¿é—´å¤±è´¥",variant:"destructive"})}finally{I(!1)}},W=(v,P)=>{navigator.clipboard.writeText(v).then(()=>{r({title:"å·²å¤åˆ¶",description:`${P}å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`})})};return e.jsxs("div",{className:"h-full overflow-y-auto p-8",children:[e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsxs(pe,{children:[e.jsxs(Ce,{children:[e.jsxs(ke,{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"h-5 w-5"}),"WebRTC è§†é¢‘é€šè¯"]}),e.jsx(zt,{children:"åˆ›å»ºæˆ¿é—´åŽï¼Œåˆ†äº«æˆ¿é—´å·å’Œå¯†ç ç»™æœ‹å‹ï¼Œå³å¯å¼€å§‹è§†é¢‘é€šè¯"})]}),e.jsxs(fe,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-2 text-sm",children:[e.jsx("span",{className:"text-green-600",children:"âœ…"}),e.jsx("span",{children:"æ— éœ€ç™»å½•å³å¯åŠ å…¥æˆ¿é—´"})]}),e.jsxs("div",{className:"flex items-start gap-2 text-sm",children:[e.jsx("span",{className:"text-green-600",children:"âœ…"}),e.jsx("span",{children:"è‡ªåŠ¨åˆ†é…æœ€ä¼˜ TURN æœåŠ¡å™¨"})]}),e.jsxs("div",{className:"flex items-start gap-2 text-sm",children:[e.jsx("span",{className:"text-green-600",children:"âœ…"}),e.jsx("span",{children:"æ”¯æŒå¤šäººè§†é¢‘é€šè¯"})]}),e.jsxs("div",{className:"flex items-start gap-2 text-sm",children:[e.jsx("span",{className:"text-green-600",children:"âœ…"}),e.jsx("span",{children:"ç«¯åˆ°ç«¯åŠ å¯†ä¼ è¾“"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs(o,{size:"lg",className:"h-32 text-lg gap-2",onClick:()=>h(!0),children:[e.jsx(Fe,{className:"h-6 w-6"}),"åˆ›å»ºæˆ¿é—´"]}),e.jsxs(o,{size:"lg",variant:"outline",className:"h-32 text-lg gap-2",onClick:()=>p(!0),children:[e.jsx(qt,{className:"h-6 w-6"}),"åŠ å…¥æˆ¿é—´"]})]}),l&&e.jsxs(pe,{children:[e.jsx(Ce,{children:e.jsx(ke,{children:"å½“å‰æˆ¿é—´"})}),e.jsxs(fe,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"æˆ¿é—´å·:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("code",{className:"text-sm bg-muted px-2 py-1 rounded",children:l.roomId}),e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>W(l.roomId,"æˆ¿é—´å·"),children:e.jsx(Be,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"å¯†ç :"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("code",{className:"text-sm bg-muted px-2 py-1 rounded",children:l.password}),e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>W(l.password,"å¯†ç "),children:e.jsx(Be,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"åˆ†äº«é“¾æŽ¥:"}),e.jsxs(o,{size:"sm",variant:"ghost",onClick:()=>W(l.shareLink,"åˆ†äº«é“¾æŽ¥"),children:[e.jsx(Be,{className:"h-4 w-4 mr-2"}),"å¤åˆ¶é“¾æŽ¥"]})]}),e.jsx(o,{className:"w-full",onClick:()=>W(`æˆ¿é—´å·: ${l.roomId}
å¯†ç : ${l.password}
é“¾æŽ¥: ${l.shareLink}`,"å…¨éƒ¨ä¿¡æ¯"),children:"å¤åˆ¶å…¨éƒ¨ä¿¡æ¯"})]})]})]}),x&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-card rounded-lg p-6 w-96 max-w-[90vw]",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"åˆ›å»ºè§†é¢‘æˆ¿é—´"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"roomName",children:"æˆ¿é—´åç§°ï¼ˆå¯é€‰ï¼‰"}),e.jsx(O,{id:"roomName",placeholder:"æˆ‘çš„æˆ¿é—´",value:w,onChange:v=>_(v.target.value)})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"roomPassword",children:"æˆ¿é—´å¯†ç ï¼ˆå¯é€‰ï¼‰"}),e.jsx(O,{id:"roomPassword",type:"password",placeholder:"ä¸å¡«è‡ªåŠ¨ç”Ÿæˆ",value:y,onChange:v=>D(v.target.value)})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"maxParticipants",children:"æœ€å¤§äººæ•°"}),e.jsxs("select",{id:"maxParticipants",className:"w-full px-3 py-2 border rounded-md bg-background",value:E,onChange:v=>F(Number(v.target.value)),children:[e.jsx("option",{value:2,children:"2äºº"}),e.jsx("option",{value:5,children:"5äºº"}),e.jsx("option",{value:10,children:"10äºº"}),e.jsx("option",{value:20,children:"20äºº"})]})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"duration",children:"æœ‰æ•ˆæœŸ"}),e.jsxs("select",{id:"duration",className:"w-full px-3 py-2 border rounded-md bg-background",value:M,onChange:v=>T(Number(v.target.value)),children:[e.jsx("option",{value:30,children:"30åˆ†é’Ÿ"}),e.jsx("option",{value:60,children:"1å°æ—¶"}),e.jsx("option",{value:120,children:"2å°æ—¶"}),e.jsx("option",{value:360,children:"6å°æ—¶"})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-6",children:[e.jsx(o,{variant:"outline",className:"flex-1",onClick:()=>h(!1),disabled:j,children:"å–æ¶ˆ"}),e.jsx(o,{className:"flex-1",onClick:b,disabled:j,children:j?e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"h-4 w-4 mr-2 animate-spin"}),"åˆ›å»ºä¸­..."]}):"åˆ›å»ºæˆ¿é—´"})]})]})}),g&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-card rounded-lg p-6 w-96 max-w-[90vw]",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"åŠ å…¥è§†é¢‘æˆ¿é—´"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"joinRoomId",children:"æˆ¿é—´å·"}),e.jsx(O,{id:"joinRoomId",placeholder:"è¾“å…¥æˆ¿é—´å·",value:R,onChange:v=>L(v.target.value)})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"joinPassword",children:"å¯†ç "}),e.jsx(O,{id:"joinPassword",type:"password",placeholder:"å¦‚æœ‰å¯†ç è¯·è¾“å…¥",value:B,onChange:v=>J(v.target.value)})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"joinNickname",children:"æ‚¨çš„æ˜µç§°"}),e.jsx(O,{id:"joinNickname",placeholder:"å¯é€‰",value:G,onChange:v=>V(v.target.value)})]})]}),e.jsxs("div",{className:"flex gap-2 mt-6",children:[e.jsx(o,{variant:"outline",className:"flex-1",onClick:()=>p(!1),disabled:$,children:"å–æ¶ˆ"}),e.jsx(o,{className:"flex-1",onClick:k,disabled:$,children:$?e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"h-4 w-4 mr-2 animate-spin"}),"åŠ å…¥ä¸­..."]}):"åŠ å…¥æˆ¿é—´"})]})]})})]})}function Ia(){const n=Ls(),{friendId:r}=_t(),{user:s,logout:x,accessToken:h}=_e(),{profile:g,loadProfile:p}=St(),{activeTab:j,setActiveTab:N,setSelectedConversation:$}=Ue(),{friends:I,loadFriends:w,loadPendingRequests:_,loadSentRequests:y}=as(),{loadMyGroups:D}=Is(),{connect:E,disconnect:F,connected:M}=Fs(),[T,R]=i.useState("main"),[L,B]=i.useState("");i.useEffect(()=>{if(r&&I.length>0){const l=I.find(f=>f.user_id===r);l&&($({id:l.user_id,type:"friend",name:l.nickname,avatar:l.avatar_url,unreadCount:0}),N("friends"))}},[r,I,$,N]),i.useEffect(()=>(s&&h&&(p().catch(console.error),E(),w().catch(console.error),_().catch(console.error),y().catch(console.error),D().catch(console.error)),()=>{F()}),[s,h]),i.useEffect(()=>{const l=Fs.getState(),f=Ue.getState(),b=u=>{console.log("æ”¶åˆ°ç§èŠæ¶ˆæ¯:",u);const q=f.selectedConversation;q?.type==="friend"&&(q.id===u.sender_id||q.id===u.receiver_id)&&f.addMessage({message_uuid:u.message_uuid,sender_id:u.sender_id,receiver_id:u.receiver_id,message_content:u.message_content,message_type:u.message_type,file_uuid:u.file_uuid,file_url:u.file_url,file_size:u.file_size,send_time:u.send_time});const ze=u.sender_id===s?.user_id?u.receiver_id:u.sender_id;f.updateConversation(ze,{lastMessage:u.message_content,lastTime:u.send_time,unreadCount:q?.id===ze?0:1})},k=u=>{if(console.log("æ”¶åˆ°ç¾¤æ¶ˆæ¯:",u),u.message_type==="system")return;const q=f.selectedConversation;q?.type==="group"&&q.id===u.group_id&&f.addMessage({message_uuid:u.message_uuid,sender_id:u.sender_id,receiver_id:u.group_id,message_content:u.message_content,message_type:u.message_type,file_uuid:u.file_uuid,file_url:u.file_url,file_size:u.file_size,send_time:u.send_time}),f.updateConversation(u.group_id,{lastMessage:u.message_content,lastTime:u.send_time,unreadCount:q?.id===u.group_id?0:1})},W=u=>{console.log("æ¶ˆæ¯è¢«æ’¤å›ž:",u),f.setMessages(f.messages.filter(q=>q.message_uuid!==u.message_uuid))},v=()=>{console.log("æ”¶åˆ°å¥½å‹è¯·æ±‚"),_().catch(console.error)},P=u=>{console.log("å¥½å‹è¯·æ±‚ç»“æžœ:",u),u.result==="approved"&&w().catch(console.error),y().catch(console.error)},Y=()=>{console.log("æ”¶åˆ°ç¾¤é‚€è¯·"),D().catch(console.error)},d=()=>{console.log("ç¾¤æˆå‘˜å˜åŒ–"),D().catch(console.error)},H=u=>{console.log("æ–‡ä»¶ä¸Šä¼ å®Œæˆ:",u),f.selectedConversation?.id,u.conversation_id},Z=u=>{console.log("æ”¶åˆ°ç¾¤å…¬å‘Š:",u);const q=f.selectedConversation;q?.type==="group"&&(q.id,u.group_id)},re=(u,q)=>{console.log("å¥½å‹å…³ç³»å˜åŒ–:",q,u),w().catch(console.error)},he=u=>{f.setTypingStatus({conversationId:u.conversation_id,conversationType:u.conversation_type,userId:u.user_id,isTyping:u.is_typing,timestamp:Date.now()})},de=u=>{console.log("åœ¨çº¿çŠ¶æ€å˜åŒ–:",u),as.getState().setOnlineStatus(u.user_id,u.status==="online")},le=l.registerHandler("private_message",b),we=l.registerHandler("group_message",k),ve=l.registerHandler("message_recalled",W),te=l.registerHandler("friend_request",v),a=l.registerHandler("friend_request_result",P),m=l.registerHandler("group_invitation",Y),z=l.registerHandler("group_member_joined",d),me=l.registerHandler("group_member_left",d),ce=l.registerHandler("file_uploaded",H),K=l.registerHandler("group_notice",Z),Q=l.registerHandler("friendship_added",u=>re(u,"added")),ue=l.registerHandler("friendship_removed",u=>re(u,"removed")),c=l.registerHandler("typing",he),X=l.registerHandler("online_status",de);return()=>{le(),we(),ve(),te(),a(),m(),z(),me(),ce(),K(),Q(),ue(),c(),X()}},[s?.user_id]);const J=async()=>{try{await x(),n("/login")}catch(l){console.error("ç™»å‡ºå¤±è´¥:",l)}},G=[{id:"friends",icon:zs,label:"å¥½å‹"},{id:"groups",icon:Se,label:"ç¾¤èŠ"},{id:"files",icon:De,label:"æ–‡ä»¶"},{id:"webrtc",icon:Fe,label:"è§†é¢‘"}],V=()=>{switch(j){case"friends":return[{id:"main",label:"å¥½å‹",icon:zs},{id:"new",label:"æ–°æœ‹å‹",icon:Ke},{id:"sent",label:"å·²å‘é€",icon:Ws}];case"groups":return[{id:"main",label:"æˆ‘çš„ç¾¤èŠ",icon:Se},{id:"invites",label:"ç¾¤é‚€è¯·",icon:Kt}];case"files":return[{id:"main",label:"æˆ‘çš„æ–‡ä»¶",icon:De},{id:"upload",label:"ä¸Šä¼ æ–‡ä»¶",icon:Ye}];default:return[]}};return e.jsxs("div",{className:"h-screen flex flex-col bg-background",children:[e.jsxs("header",{className:"h-16 border-b bg-card flex items-center justify-between px-4 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ne,{className:"h-10 w-10",children:[e.jsx(xe,{src:g?.user_avatar_url||s?.avatar_url}),e.jsx(ie,{className:"bg-primary text-primary-foreground",children:(g?.user_nickname||s?.nickname)?.[0]?.toUpperCase()||"U"})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold text-sm",children:g?.user_nickname||s?.nickname||s?.user_id}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${M?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:"text-xs text-muted-foreground",children:M?"å·²è¿žæŽ¥":"æœªè¿žæŽ¥"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>n("/settings"),children:e.jsx(rs,{className:"h-5 w-5"})}),e.jsx(o,{variant:"ghost",size:"icon",onClick:J,children:e.jsx(Mt,{className:"h-5 w-5"})})]})]}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsx("aside",{className:"w-20 border-r bg-card flex flex-col items-center py-4 gap-2 shrink-0",children:G.map(l=>e.jsx(o,{variant:j===l.id?"default":"ghost",size:"icon",className:`w-14 h-14 rounded-2xl transition-all ${j===l.id?"shadow-lg":""}`,onClick:()=>{N(l.id),R("main")},title:l.label,children:e.jsx(l.icon,{className:"h-6 w-6"})},l.id))}),e.jsxs("div",{className:"w-80 border-r bg-card flex flex-col shrink-0",children:[j!=="webrtc"&&e.jsx("div",{className:"border-b",children:e.jsx("div",{className:"flex",children:V().map(l=>e.jsxs("button",{className:`flex-1 px-4 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-2 ${T===l.id?"text-primary border-b-2 border-primary":"text-muted-foreground hover:text-foreground"}`,onClick:()=>R(l.id),children:[e.jsx(l.icon,{className:"h-4 w-4"}),l.label]},l.id))})}),j!=="webrtc"&&T==="main"&&e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"relative",children:[e.jsx(Js,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(O,{placeholder:`æœç´¢${j==="friends"?"å¥½å‹":j==="groups"?"ç¾¤èŠ":"æ–‡ä»¶"}...`,value:L,onChange:l=>B(l.target.value),className:"pl-9"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs(Ve,{mode:"wait",children:[j==="friends"&&e.jsx(ge.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.2},children:e.jsx(na,{subTab:T==="invites"?"new":T,searchQuery:L})},"friends"),j==="groups"&&e.jsx(ge.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.2},children:e.jsx(ia,{subTab:T==="upload"?"main":T,searchQuery:L})},"groups"),j==="files"&&e.jsx(ge.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.2},children:e.jsx(ca,{subTab:["main","upload"].includes(T)?T:"main"})},"files")]})})]}),e.jsx("main",{className:"flex-1 flex flex-col bg-background",children:e.jsx(Ve,{mode:"wait",children:j==="webrtc"?e.jsx(ge.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.2},className:"flex-1",children:e.jsx(oa,{})},"webrtc"):e.jsx(ge.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.2},className:"flex-1",children:e.jsx(la,{})},"chat")})})]})]})}export{Ia as default};

import{c as w,a as d,n as u,l as p,E as y,F as m}from"./index-DW35rIVo.js";const k=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],P=w("camera",k);const E=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],T=w("eye",E),i=`${u()}/api/profile`,f=()=>{const r=d.getState().accessToken;return{"Content-Type":"application/json",...r?{Authorization:`Bearer ${r}`}:{}}},g=async(r,a={})=>{const o=d.getState();if(o.checkTokenExpiry()&&o.refreshToken)try{await o.refreshAccessToken()}catch(t){console.error("Failed to refresh token:",t)}const e=f();let s=await fetch(r,{...a,headers:{...e,...a.headers}});if(s.status===401&&o.refreshToken)try{await o.refreshAccessToken();const t=f();s=await fetch(r,{...a,headers:{...t,...a.headers}})}catch(t){throw console.error("Token refresh failed, redirecting to login"),o.clearAuth(),window.location.href="/login",t}return s},n={getProfile:async()=>{console.log("ðŸ‘¤ èŽ·å–ä¸ªäººèµ„æ–™");const r=await g(`${i}`,{method:"GET"});if(!r.ok){const o=await r.json().catch(()=>({message:`èŽ·å–ä¸ªäººèµ„æ–™å¤±è´¥ (${r.status})`}));throw console.error("èŽ·å–ä¸ªäººèµ„æ–™å¤±è´¥:",o),new Error(o.message||o.error||"èŽ·å–ä¸ªäººèµ„æ–™å¤±è´¥")}const a=await r.json();return a.data||a},updateProfile:async r=>{console.log("âœï¸ æ›´æ–°ä¸ªäººèµ„æ–™:",r);const a=await g(`${i}`,{method:"PUT",body:JSON.stringify(r)});if(!a.ok){const e=await a.json().catch(()=>({message:`æ›´æ–°ä¸ªäººèµ„æ–™å¤±è´¥ (${a.status})`}));throw console.error("æ›´æ–°ä¸ªäººèµ„æ–™å¤±è´¥:",e),new Error(e.message||e.error||"æ›´æ–°ä¸ªäººèµ„æ–™å¤±è´¥")}const o=await a.json();return console.log("âœ… ä¸ªäººèµ„æ–™æ›´æ–°æˆåŠŸ"),o},changePassword:async r=>{console.log("ðŸ” ä¿®æ”¹å¯†ç ");const a=await g(`${i}/password`,{method:"PUT",body:JSON.stringify(r)});if(!a.ok){const e=await a.json().catch(()=>({message:`ä¿®æ”¹å¯†ç å¤±è´¥ (${a.status})`}));throw console.error("ä¿®æ”¹å¯†ç å¤±è´¥:",e),new Error(e.message||e.error||"ä¿®æ”¹å¯†ç å¤±è´¥")}const o=await a.json();return console.log("âœ… å¯†ç ä¿®æ”¹æˆåŠŸ"),o},uploadAvatar:async r=>{console.log("ðŸ“¸ ä¸Šä¼ å¤´åƒ:",r.name);const a=10*1024*1024;if(r.size>a)throw new Error(`æ–‡ä»¶å¤ªå¤§ï¼Œæœ€å¤§ 10MBï¼Œå½“å‰: ${(r.size/1024/1024).toFixed(2)} MB`);if(!["image/jpeg","image/png","image/gif","image/webp"].includes(r.type))throw new Error("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œæ”¯æŒ: jpg, jpeg, png, gif, webp");const e=new FormData;e.append("avatar",r);const t=d.getState().accessToken,c=await fetch(`${i}/avatar`,{method:"POST",headers:{...t?{Authorization:`Bearer ${t}`}:{}},body:e});if(!c.ok){const l=await c.json().catch(()=>({message:`ä¸Šä¼ å¤´åƒå¤±è´¥ (${c.status})`}));throw console.error("ä¸Šä¼ å¤´åƒå¤±è´¥:",l),new Error(l.message||l.error||"ä¸Šä¼ å¤´åƒå¤±è´¥")}const h=await c.json();return console.log("âœ… å¤´åƒä¸Šä¼ æˆåŠŸ:",h.avatar_url),h}},A=p()(y((r,a)=>({profile:null,isLoading:!1,error:null,loadProfile:async()=>{r({isLoading:!0,error:null});try{const o=await n.getProfile();r({profile:o,isLoading:!1})}catch(o){const e=o instanceof Error?o.message:"åŠ è½½ä¸ªäººèµ„æ–™å¤±è´¥";throw r({error:e,isLoading:!1}),o}},updateProfile:async o=>{r({isLoading:!0,error:null});try{await n.updateProfile(o);const e=await n.getProfile();r({profile:e,isLoading:!1})}catch(e){const s=e instanceof Error?e.message:"æ›´æ–°ä¸ªäººèµ„æ–™å¤±è´¥";throw r({error:s,isLoading:!1}),e}},uploadAvatar:async o=>{r({isLoading:!0,error:null});try{const{avatar_url:e}=await n.uploadAvatar(o),s=a().profile;r(s?{profile:{...s,user_avatar_url:e},isLoading:!1}:{isLoading:!1})}catch(e){const s=e instanceof Error?e.message:"ä¸Šä¼ å¤´åƒå¤±è´¥";throw r({error:s,isLoading:!1}),e}},changePassword:async o=>{r({isLoading:!0,error:null});try{await n.changePassword(o),r({isLoading:!1})}catch(e){const s=e instanceof Error?e.message:"ä¿®æ”¹å¯†ç å¤±è´¥";throw r({error:s,isLoading:!1}),e}},clearProfile:()=>{r({profile:null,error:null})},clearError:()=>{r({error:null})}}),{name:"profile-storage",storage:m(()=>localStorage),partialize:r=>({profile:r.profile})}));export{P as C,T as E,n as p,A as u};
